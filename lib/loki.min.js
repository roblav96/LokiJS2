!function(t,e){if("object"==typeof exports&&"object"==typeof module)module.exports=e();else if("function"==typeof define&&define.amd)define([],e);else{var i=e();for(var n in i)("object"==typeof exports?exports:t)[n]=i[n]}}(this,function(){return function(t){function e(n){if(i[n])return i[n].exports;var r=i[n]={i:n,l:!1,exports:{}};return t[n].call(r.exports,r,r.exports,e),r.l=!0,r.exports}var i={};return e.m=t,e.c=i,e.i=function(t){return t},e.d=function(t,i,n){e.o(t,i)||Object.defineProperty(t,i,{configurable:!1,enumerable:!0,get:n})},e.n=function(t){var i=t&&t.__esModule?function(){return t.default}:function(){return t};return e.d(i,"a",i),i},e.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},e.p="",e(e.s=5)}([function(t,e,i){"use strict";class n{constructor(){this.events={},this.asyncListeners=!1}on(t,e){var i,n=this;return Array.isArray(t)?(t.forEach(function(t){n.on(t,e)}),e):(i=this.events[t],i||(i=this.events[t]=[]),i.push(e),e)}emit(t,e){var i=this;t&&this.events[t]&&this.events[t].forEach(function(t){i.asyncListeners?setTimeout(function(){t(e)},1):t(e)})}addListener(t,e){return this.on(t,e)}removeListener(t,e){var i=this;if(Array.isArray(t)&&t.forEach(function(t){i.removeListener(t,listen)}),this.events[t]){var n=this.events[t];n.splice(n.indexOf(e),1)}}}e.a=n},function(t,e,i){"use strict";function n(t){return-1!==t.indexOf(".")}function r(t){return parseFloat(t,10)}function s(t,e){return t+e}function o(t,e){return t-e}function a(t){return t.reduce(s,0)/t.length}function l(t){var e=a(t),i=t.map(function(t){var i=t-e;return i*i}),n=a(i);return Math.sqrt(n)}function h(t,e,i){if(!1===i)return t[e];for(var n=e.split("."),r=t;n.length>0;)r=r[n.shift()];return r}var u=i(0),c=i(13),f=i(12),d=i(6),p=i(11),v=i(3),y=i(4),g=i(5);class m extends u.a{constructor(t,e){function i(t){var e="function"==typeof Set?new Set:[];e.add||(e.add=function(t){return-1===this.indexOf(t)&&this.push(t),this}),t.forEach(function(t){e.add(t.object)}),e.forEach(function(t){if(!hasOwnProperty.call(t,"$loki"))return p.removeAutoUpdateObserver(t);try{p.update(t)}catch(t){}})}function n(t,e,i){p.changes.push({name:t,operation:e,obj:JSON.parse(JSON.stringify(i))})}function r(){p.changes=[]}function s(t){t&&(t.meta||(t.meta={}),t.meta.created=(new Date).getTime(),t.meta.revision=0)}function o(t){t&&(t.meta.updated=(new Date).getTime(),t.meta.revision+=1)}function a(t){n(p.name,"I",t)}function l(t){n(p.name,"U",t)}function h(t){s(t),a(t)}function u(t){o(t),l(t)}function d(){m=p.disableChangesApi?s:h,w=p.disableChangesApi?o:u}super(),this.name=t,this.data=[],this.idIndex=[],this.binaryIndices={},this.constraints={unique:{},exact:{}},this.uniqueNames=[],this.transforms={},this.objType=t,this.dirty=!0,this.cachedIndex=null,this.cachedBinaryIndex=null,this.cachedData=null;var p=this;e=e||{},e.hasOwnProperty("unique")&&(Array.isArray(e.unique)||(e.unique=[e.unique]),e.unique.forEach(function(t){p.uniqueNames.push(t),p.constraints.unique[t]=new c.a(t)})),e.hasOwnProperty("exact")&&e.exact.forEach(function(t){p.constraints.exact[t]=new f.a(t)}),this._fullTextSearch=null,void 0!==g.Loki.FullTextSearch&&(this._fullTextSearch=e.hasOwnProperty("fullTextSearch")?new g.Loki.FullTextSearch.FullTextSearch(e.fullTextSearch):null),this.adaptiveBinaryIndices=!e.hasOwnProperty("adaptiveBinaryIndices")||e.adaptiveBinaryIndices,this.transactional=!!e.hasOwnProperty("transactional")&&e.transactional,this.cloneObjects=!!e.hasOwnProperty("clone")&&e.clone,this.cloneMethod=e.hasOwnProperty("cloneMethod")?e.cloneMethod:"parse-stringify",this.asyncListeners=!!e.hasOwnProperty("asyncListeners")&&e.asyncListeners,this.disableChangesApi=!e.hasOwnProperty("disableChangesApi")||e.disableChangesApi,this.autoupdate=!!e.hasOwnProperty("autoupdate")&&e.autoupdate,this.ttl={age:null,ttlInterval:null,daemon:null},this.setTTL(e.ttl||-1,e.ttlInterval),this.maxId=0,this.DynamicViews=[],this.events={insert:[],update:[],"pre-insert":[],"pre-update":[],close:[],flushbuffer:[],error:[],delete:[],warning:[]},this.changes=[],this.ensureId();var v=[];if(e&&e.indices)if("[object Array]"===Object.prototype.toString.call(e.indices))v=e.indices;else{if("string"!=typeof e.indices)throw new TypeError("Indices needs to be a string or an array of strings");v=[e.indices]}for(var y=0;y<v.length;y++)this.ensureIndex(v[y]);this.observerCallback=i,this.getChanges=function(){return p.changes},this.flushChanges=r;var m,w;d(),this.setChangesApi=function(t){p.disableChangesApi=!t,d()},this.on("insert",function(t){m(t)}),this.on("update",function(t){w(t)}),this.on("delete",function(t){p.disableChangesApi||n(p.name,"R",t)}),this.on("warning",function(t){p.console.warn(t)}),r(),this.console={log:function(){},warn:function(){},error:function(){}},this.stages={},this.commitLog=[]}addAutoUpdateObserver(t){this.autoupdate&&"function"==typeof Object.observe&&Object.observe(t,this.observerCallback,["add","update","delete","reconfigure","setPrototype"])}removeAutoUpdateObserver(t){this.autoupdate&&"function"==typeof Object.observe&&Object.unobserve(t,this.observerCallback)}addTransform(t,e){if(this.transforms.hasOwnProperty(t))throw new Error("a transform by that name already exists");this.transforms[t]=e}setTransform(t,e){this.transforms[t]=e}removeTransform(t){delete this.transforms[t]}byExample(t){var e,i,n;n=[];for(e in t)t.hasOwnProperty(e)&&n.push((i={},i[e]=t[e],i));return{$and:n}}findObject(t){return this.findOne(this.byExample(t))}findObjects(t){return this.find(this.byExample(t))}ttlDaemonFuncGen(){var t=this,e=this.ttl.age;return function(){var i=Date.now();t.chain().where(function(t){var n=t.meta.updated||t.meta.created;return e<i-n}).remove()}}setTTL(t,e){t<0?clearInterval(this.ttl.daemon):(this.ttl.age=t,this.ttl.ttlInterval=e,this.ttl.daemon=setInterval(this.ttlDaemonFuncGen(),e))}prepareFullDocIndex(){for(var t=this.data.length,e=new Array(t),i=0;i<t;i+=1)e[i]=i;return e}configureOptions(t){t=t||{},t.hasOwnProperty("adaptiveBinaryIndices")&&(this.adaptiveBinaryIndices=t.adaptiveBinaryIndices,this.adaptiveBinaryIndices&&this.ensureAllIndexes())}ensureIndex(t,e){if(void 0===e&&(e=!1),null===t||void 0===t)throw new Error("Attempting to set index without an associated property");if((!this.binaryIndices[t]||e||this.binaryIndices[t].dirty)&&(!0!==this.adaptiveBinaryIndices||!this.binaryIndices.hasOwnProperty(t)||e)){var n={name:t,dirty:!0,values:this.prepareFullDocIndex()};this.binaryIndices[t]=n;var r=function(t,e){return function(n,r){var s=e[n][t],o=e[r][t];if(s!==o){if(i.i(y.a)(s,o,!1))return-1;if(i.i(y.b)(s,o,!1))return 1}return 0}}(t,this.data);n.values.sort(r),n.dirty=!1,this.dirty=!0}}getSequencedIndexValues(t){var e,i=this.binaryIndices[t].values,n="";for(e=0;e<i.length;e++)n+=" ["+e+"] "+this.data[i[e]][t];return n}ensureUniqueIndex(t){var e=this.constraints.unique[t];return e||-1==this.uniqueNames.indexOf(t)&&this.uniqueNames.push(t),this.constraints.unique[t]=e=new c.a(t),this.data.forEach(function(t){e.set(t)}),e}ensureAllIndexes(t){var e,i=this.binaryIndices;for(e in i)hasOwnProperty.call(i,e)&&this.ensureIndex(e,t)}flagBinaryIndexesDirty(){var t,e=this.binaryIndices;for(t in e)hasOwnProperty.call(e,t)&&(e[t].dirty=!0)}flagBinaryIndexDirty(t){this.binaryIndices[t]&&(this.binaryIndices[t].dirty=!0)}count(t){return t?this.chain().find(t).filteredrows.length:this.data.length}ensureId(){var t=this.data.length,e=0;for(this.idIndex=[],e;e<t;e+=1)this.idIndex.push(this.data[e].$loki)}addDynamicView(t,e){var i=new p.a(this,t,e);return this.DynamicViews.push(i),i}removeDynamicView(t){for(var e=0;e<this.DynamicViews.length;e++)this.DynamicViews[e].name===t&&this.DynamicViews.splice(e,1)}getDynamicView(t){for(var e=0;e<this.DynamicViews.length;e++)if(this.DynamicViews[e].name===t)return this.DynamicViews[e];return null}findAndUpdate(t,e){"function"==typeof t?this.updateWhere(t,e):this.chain().find(t).update(e)}findAndRemove(t){this.chain().find(t).remove()}insert(t){if(!Array.isArray(t))return this.insertOne(t);var e,i=[];this.emit("pre-insert",t);for(var n=0,r=t.length;n<r;n++){if(!(e=this.insertOne(t[n],!0)))return;i.push(e)}return this.emit("insert",t),1===i.length?i[0]:i}insertOne(t,e){var n,r=null;if("object"!=typeof t?r=new TypeError("Document needs to be an object"):null===t&&(r=new TypeError("Object cannot be null")),null!==r)throw this.emit("error",r),r;var s=this.cloneObjects?i.i(v.a)(t,this.cloneMethod):t;if(void 0===s.meta&&(s.meta={revision:0,created:0}),e||this.emit("pre-insert",s),this.add(s))return null!==this._fullTextSearch&&this._fullTextSearch.addDocument(t),n=this.cloneObjects?i.i(v.a)(s,this.cloneMethod):s,this.addAutoUpdateObserver(n),e||this.emit("insert",n),n}clear(t){var e=this;if(t=t||{},this.data=[],this.idIndex=[],this.cachedIndex=null,this.cachedBinaryIndex=null,this.cachedData=null,this.maxId=0,this.DynamicViews=[],this.dirty=!0,!0===t.removeIndices)this.binaryIndices={},this.constraints={unique:{},exact:{}},this.uniqueNames=[];else{Object.keys(this.binaryIndices).forEach(function(t){e.binaryIndices[t].dirty=!1,e.binaryIndices[t].values=[]}),this.constraints={unique:{},exact:{}},this.uniqueNames.forEach(function(t){e.ensureUniqueIndex(t)})}}update(t){if(Array.isArray(t)){var e=0,n=t.length;for(e;e<n;e+=1)this.update(t[e])}else{if(!hasOwnProperty.call(t,"$loki"))throw new Error("Trying to update unsynced document. Please save the document first by using insert() or addMany()");try{this.startTransaction();var r,s,o,a=this.get(t.$loki,!0),l=this;if(!a)throw new Error("Trying to update a document not in collection.");r=a[0],o=a[1],s=this.cloneObjects?i.i(v.a)(t,this.cloneMethod):t,this.emit("pre-update",t),Object.keys(this.constraints.unique).forEach(function(t){l.constraints.unique[t].update(r,s)}),this.data[o]=s,s!==t&&this.addAutoUpdateObserver(t);for(var h=0;h<this.DynamicViews.length;h++)this.DynamicViews[h].evaluateDocument(o,!1);var u;if(this.adaptiveBinaryIndices){var c=this.binaryIndices;for(u in c)this.adaptiveBinaryIndexUpdate(o,u)}else this.flagBinaryIndexesDirty();return this.idIndex[o]=s.$loki,null!==this._fullTextSearch&&this._fullTextSearch.updateDocument(t),this.commit(),this.dirty=!0,this.emit("update",t,this.cloneObjects?i.i(v.a)(r,this.cloneMethod):null),t}catch(t){throw this.rollback(),this.console.error(t.message),this.emit("error",t),t}}}add(t){if("object"!=typeof t)throw new TypeError("Object being added needs to be an object");if(void 0!==t.$loki)throw new Error("Document is already in collection, please use update()");try{this.startTransaction(),this.maxId++,isNaN(this.maxId)&&(this.maxId=this.data[this.data.length-1].$loki+1),t.$loki=this.maxId,t.meta.version=0;var e,n=this.constraints.unique;for(e in n)hasOwnProperty.call(n,e)&&n[e].set(t);this.idIndex.push(t.$loki),this.data.push(t);for(var r=this.data.length-1,s=this.DynamicViews.length,o=0;o<s;o++)this.DynamicViews[o].evaluateDocument(r,!0);if(this.adaptiveBinaryIndices){var a=this.binaryIndices;for(e in a)this.adaptiveBinaryIndexInsert(r,e)}else this.flagBinaryIndexesDirty();return this.commit(),this.dirty=!0,this.cloneObjects?i.i(v.a)(t,this.cloneMethod):t}catch(t){throw this.rollback(),this.console.error(t.message),this.emit("error",t),t}}updateWhere(t,e){var i,n=this.where(t),r=0;try{for(r;r<n.length;r++)i=e(n[r]),this.update(i)}catch(t){this.rollback(),this.console.error(t.message)}}removeWhere(t){var e;"function"==typeof t?(e=this.data.filter(t),this.remove(e)):this.chain().find(t).remove()}removeDataOnly(){this.remove(this.data.slice())}remove(t){if("number"==typeof t&&(t=this.get(t)),"object"!=typeof t)throw new Error("Parameter is not an object");if(Array.isArray(t)){var e=0,i=t.length;for(e;e<i;e+=1)this.remove(t[e])}else{if(!hasOwnProperty.call(t,"$loki"))throw new Error("Object is not a document stored in the collection");try{this.startTransaction();var n=this.get(t.$loki,!0),r=n[1],s=this;Object.keys(this.constraints.unique).forEach(function(e){null!==t[e]&&void 0!==t[e]&&s.constraints.unique[e].remove(t[e])});for(var o=0;o<this.DynamicViews.length;o++)this.DynamicViews[o].removeDocument(r);if(this.adaptiveBinaryIndices){var a,l=this.binaryIndices;for(a in l)this.adaptiveBinaryIndexRemove(r,a)}else this.flagBinaryIndexesDirty();return this.data.splice(r,1),this.removeAutoUpdateObserver(t),this.idIndex.splice(r,1),null!=this._fullTextSearch&&this._fullTextSearch.removeDocument(t),this.commit(),this.dirty=!0,this.emit("delete",n[0]),delete t.$loki,delete t.meta,t}catch(t){return this.rollback(),this.console.error(t.message),this.emit("error",t),null}}}get(t,e){var i=e||!1,n=this.idIndex,r=n.length-1,s=0,o=s+r>>1;if(t="number"==typeof t?t:parseInt(t,10),isNaN(t))throw new TypeError("Passed id is not an integer");for(;n[s]<n[r];)o=s+r>>1,n[o]<t?s=o+1:r=o;return r===s&&n[s]===t?i?[this.data[s],s]:this.data[s]:null}getBinaryIndexPosition(t,e){var i=this.data[t][e],n=this.binaryIndices[e].values,r=this.calculateRange("$eq",e,i);if(0===r[0]&&-1===r[1])return null;for(var s=r[0],o=r[1],a=s;a<=o;a++)if(n[a]===t)return a;return null}adaptiveBinaryIndexInsert(t,e){var i=(this.binaryIndices[e].values,this.data[t][e]),n=this.calculateRangeStart(e,i);this.binaryIndices[e].values.splice(n,0,t)}adaptiveBinaryIndexUpdate(t,e){var i,n=this.binaryIndices[e].values,r=n.length;for(i=0;i<r&&n[i]!==t;i++);this.binaryIndices[e].values.splice(i,1),this.adaptiveBinaryIndexInsert(t,e)}adaptiveBinaryIndexRemove(t,e,i){var n,r,s=this.getBinaryIndexPosition(t,e),o=this.binaryIndices[e].values;if(null===s)return null;if(this.binaryIndices[e].values.splice(s,1),!0!==i)for(n=o.length,r=0;r<n;r++)o[r]>t&&o[r]--}calculateRangeStart(t,e){var n=this.data,r=this.binaryIndices[t].values,s=0,o=r.length-1,a=0;if(0===r.length)return 0;for(n[r[s]][t],n[r[o]][t];s<o;)a=s+o>>1,i.i(y.a)(n[r[a]][t],e,!1)?s=a+1:o=a;var l=s;return i.i(y.a)(n[r[l]][t],e,!1)?l+1:l}calculateRangeEnd(t,e){var n=this.data,r=this.binaryIndices[t].values,s=0,o=r.length-1,a=0;if(0===r.length)return 0;for(n[r[s]][t],n[r[o]][t];s<o;)a=s+o>>1,i.i(y.a)(e,n[r[a]][t],!1)?o=a:s=a+1;var l=o;return i.i(y.b)(n[r[l]][t],e,!1)?l-1:l}calculateRange(t,e,n){var r=this.data,s=this.binaryIndices[e].values,o=0,a=s.length-1,l=0;if(0===r.length)return[0,-1];var h=r[s[o]][e],u=r[s[a]][e];switch(t){case"$eq":case"$aeq":case"$dteq":if(i.i(y.a)(n,h,!1)||i.i(y.b)(n,u,!1))return[0,-1];break;case"$gt":if(i.i(y.b)(n,u,!0))return[0,-1];break;case"$gte":if(i.i(y.b)(n,u,!1))return[0,-1];break;case"$lt":if(i.i(y.a)(n,h,!0))return[0,-1];if(i.i(y.a)(u,n,!1))return[0,r.length-1];break;case"$lte":if(i.i(y.a)(n,h,!1))return[0,-1];if(i.i(y.a)(u,n,!0))return[0,r.length-1];break;case"$between":return[this.calculateRangeStart(e,n[0]),this.calculateRangeEnd(e,n[1])];case"$in":for(var c=[],f=[],d=0,p=n.length;d<p;d++)for(var v=this.calculateRange("$eq",e,n[d]),g=v[0];g<=v[1];g++)void 0===c[g]&&(c[g]=!0,f.push(g));return f}for(;o<a;)l=o+a>>1,i.i(y.a)(r[s[l]][e],n,!1)?o=l+1:a=l;var m=o;for(a=s.length-1;o<a;)l=o+a>>1,i.i(y.a)(n,r[s[l]][e],!1)?a=l:o=l+1;var w=a,b=r[s[m]][e],I=r[s[w]][e];switch(t){case"$eq":return b!==n?[0,-1]:(I!==n&&w--,[m,w]);case"$dteq":return b>n||b<n?[0,-1]:((I>n||I<n)&&w--,[m,w]);case"$gt":return i.i(y.a)(I,n,!0)?[0,-1]:[w,r.length-1];case"$gte":return i.i(y.a)(b,n,!1)?[0,-1]:[m,r.length-1];case"$lt":return 0===m&&i.i(y.a)(b,n,!1)?[0,0]:[0,m-1];case"$lte":return I!==n&&w--,0===w&&i.i(y.a)(I,n,!1)?[0,0]:[0,w];default:return[0,r.length-1]}}by(t,e){var n;if(void 0===e)return n=this,function(e){return n.by(t,e)};var r=this.constraints.unique[t].get(e);return this.cloneObjects?i.i(v.a)(r,this.cloneMethod):r}findOne(t){t=t||{};var e=new d.a(this,{queryObj:t,firstOnly:!0});return Array.isArray(e)&&0===e.length?null:this.cloneObjects?i.i(v.a)(e,this.cloneMethod):e}chain(t,e){var i=new d.a(this);return void 0===t?i:i.transform(t,e)}find(t){void 0===t&&(t="getAll");var e=new d.a(this,{queryObj:t});return this.cloneObjects?i.i(v.b)(e,this.cloneMethod):e}findOneUnindexed(t,e){for(var i=this.data.length;i--;)if(this.data[i][t]===e)return this.data[i];return null}startTransaction(){if(this.transactional){this.cachedData=i.i(v.a)(this.data,this.cloneMethod),this.cachedIndex=this.idIndex,this.cachedBinaryIndex=this.binaryIndices;for(var t=0;t<this.DynamicViews.length;t++)this.DynamicViews[t].startTransaction()}}commit(){if(this.transactional){this.cachedData=null,this.cachedIndex=null,this.cachedBinaryIndex=null;for(var t=0;t<this.DynamicViews.length;t++)this.DynamicViews[t].commit()}}rollback(){if(this.transactional){null!==this.cachedData&&null!==this.cachedIndex&&(this.data=this.cachedData,this.idIndex=this.cachedIndex,this.binaryIndices=this.cachedBinaryIndex);for(var t=0;t<this.DynamicViews.length;t++)this.DynamicViews[t].rollback()}}where(t){var e=new d.a(this,{queryFunc:t});return this.cloneObjects?i.i(v.b)(e,this.cloneMethod):e}mapReduce(t,e){try{return e(this.data.map(t))}catch(t){throw t}}eqJoin(t,e,i,n){return new d.a(this).eqJoin(t,e,i,n)}getStage(t){return this.stages[t]||(this.stages[t]={}),this.stages[t]}stage(t,e){var i=JSON.parse(JSON.stringify(e));return this.getStage(t)[e.$loki]=i,i}commitStage(t,e){var i,n=this.getStage(t),r=(new Date).getTime();for(i in n)this.update(n[i]),this.commitLog.push({timestamp:r,message:e,data:JSON.parse(JSON.stringify(n[i]))});this.stages[t]={}}no_op(){}extract(t){var e=0,i=this.data.length,r=n(t),s=[];for(e;e<i;e+=1)s.push(h(this.data[e],t,r));return s}max(t){return Math.max.apply(null,this.extract(t))}min(t){return Math.min.apply(null,this.extract(t))}maxRecord(t){var e,i=0,r=this.data.length,s=n(t),o={index:0,value:void 0};for(i;i<r;i+=1)void 0!==e?e<h(this.data[i],t,s)&&(e=h(this.data[i],t,s),o.index=this.data[i].$loki):(e=h(this.data[i],t,s),o.index=this.data[i].$loki);return o.value=e,o}minRecord(t){var e,i=0,r=this.data.length,s=n(t),o={index:0,value:void 0};for(i;i<r;i+=1)void 0!==e?e>h(this.data[i],t,s)&&(e=h(this.data[i],t,s),o.index=this.data[i].$loki):(e=h(this.data[i],t,s),o.index=this.data[i].$loki);return o.value=e,o}extractNumerical(t){return this.extract(t).map(r).filter(Number).filter(function(t){return!isNaN(t)})}avg(t){return a(this.extractNumerical(t))}stdDev(t){return l(this.extractNumerical(t))}mode(t){var e={};this.extract(t).forEach(function(t){e[t]?e[t]+=1:e[t]=1});var i,n,r;for(n in e)i?i<e[n]&&(r=n):(r=n,i=e[n]);return r}median(t){var e=this.extractNumerical(t);e.sort(o);var i=Math.floor(e.length/2);return e.length%2?e[i]:(e[i-1]+e[i])/2}}e.a=m},function(t,e,i){"use strict";i.d(e,"a",function(){return n});var n={copyProperties:function(t,e){var i;for(i in t)e[i]=t[i]},resolveTransformObject:function(t,e,i){var r,s;if("number"!=typeof i&&(i=0),++i>=10)return t;for(r in t)"string"==typeof t[r]&&0===t[r].indexOf("[%lktxp]")?(s=t[r].substring(8),e.hasOwnProperty(s)&&(t[r]=e[s])):"object"==typeof t[r]&&(t[r]=n.resolveTransformObject(t[r],e,i));return t},resolveTransformParams:function(t,e){var i,r,s=[];if(void 0===e)return t;for(i=0;i<t.length;i++)r=JSON.parse(JSON.stringify(t[i])),s.push(n.resolveTransformObject(r,e));return s}}},function(t,e,i){"use strict";function n(t,e){if(null===t||void 0===t)return null;var i,n=e||"parse-stringify";switch(n){case"parse-stringify":i=JSON.parse(JSON.stringify(t));break;case"jquery-extend-deep":i=jQuery.extend(!0,{},t);break;case"shallow":i=Object.create(t.prototype||null),Object.keys(t).map(function(e){i[e]=t[e]})}return i}function r(t,e){var i,r=[];if("parse-stringify"==e)return n(t,e);for(i=t.length-1;i<=0;i--)r.push(n(t[i],e));return r}e.a=n,e.b=r},function(t,e,i){"use strict";function n(t,e,i){var n,r;if(!t||!e||!0===t||!0===e){if(!(!0!==t&&!1!==t||!0!==e&&!1!==e))return i?t===e:!t&&e;if(void 0===e||null===e||!0===t||!1===e)return i;if(void 0===t||null===t||!1===t||!0===e)return!0}return t===e?i:t<e||!(t>e)&&(n=t.toString(),r=e.toString(),n==r?i:n<r)}function r(t,e,i){var n,r;if(!t||!e||!0===t||!0===e){if(!(!0!==t&&!1!==t||!0!==e&&!1!==e))return i?t===e:!!t&&!e;if(void 0===t||null===t||!1===t||!0===e)return i;if(void 0===e||null===e||!0===t||!1===e)return!0}return t===e?i:t>e||!(t<e)&&(n=t.toString(),r=e.toString(),n==r?i:n>r)}e.a=n,e.b=r},function(t,e,i){"use strict";(function(t){Object.defineProperty(e,"__esModule",{value:!0});var n=i(0),r=i(7),s=i(8),o=i(1),a=i(2);class l extends n.a{constructor(e,i){super(),this.filename=e||"loki.db",this.collections=[],this.databaseVersion=1.1,this.engineVersion=1.1,this.autosave=!1,this.autosaveInterval=5e3,this.autosaveHandle=null,this.options={serializationMethod:i&&i.hasOwnProperty("serializationMethod")?i.serializationMethod:"normal",destructureDelimiter:i&&i.hasOwnProperty("destructureDelimiter")?i.destructureDelimiter:"$<\n"},this.persistenceMethod=null,this.persistenceAdapter=null,this.verbose=!(!i||!i.hasOwnProperty("verbose"))&&i.verbose,this.events={init:[],loaded:[],flushChanges:[],close:[],changes:[],warning:[]};i&&i.hasOwnProperty("env")?this.ENV=i.env:this.ENV=function(){return"undefined"==typeof window?"NODEJS":void 0!==t&&t.window?"NODEJS":"undefined"!=typeof document?-1===document.URL.indexOf("http://")&&-1===document.URL.indexOf("https://")?"CORDOVA":"BROWSER":"CORDOVA"}(),this.on("init",this.clearChanges)}getIndexedAdapter(){return i(9)}initializePersistence(t){var e=this,i={NODEJS:"fs",BROWSER:"localStorage",CORDOVA:"localStorage"},n={fs:r.a,localStorage:s.a};this.options=t||{},this.persistenceMethod=null,this.persistenceAdapter=null,this.options.hasOwnProperty("persistenceMethod")&&"function"==typeof n[this.options.persistenceMethod]&&(this.persistenceMethod=this.options.persistenceMethod,this.persistenceAdapter=new n[this.options.persistenceMethod]),this.options.hasOwnProperty("serializationMethod")||(this.options.serializationMethod="normal"),this.options.hasOwnProperty("destructureDelimiter")||(this.options.destructureDelimiter="$<\n"),null===this.persistenceAdapter&&(this.persistenceMethod=i[this.ENV],this.persistenceMethod&&(this.persistenceAdapter=new n[this.persistenceMethod])),this.options.hasOwnProperty("adapter")&&(this.persistenceMethod="adapter",this.persistenceAdapter=this.options.adapter),this.options.hasOwnProperty("autosaveInterval")&&(this.autosaveInterval=parseInt(this.options.autosaveInterval,10)),this.autosaveDisable();var o;return o=this.options.autoload?this.loadDatabase(this.options.inflate):Promise.resolve(),o.then(function(){e.options.autosave&&e.autosaveEnable()})}copy(t){var e,i,n=new l(this.filename);if(t=t||{},n.loadJSONObject(this,{retainDirtyFlags:!0}),t.hasOwnProperty("removeNonSerializable")&&!0===t.removeNonSerializable)for(n.autosaveHandle=null,n.persistenceAdapter=null,e=n.collections.length,i=0;i<e;i++)n.collections[i].constraints=null,n.collections[i].ttl=null;return n}anonym(t,e){var i=new o.a("anonym",e);return i.insert(t),this.verbose&&(i.console=console),i}addCollection(t,e){var i=new o.a(t,e);return this.collections.push(i),this.verbose&&(i.console=console),i}loadCollection(t){if(!t.name)throw new Error("Collection must have a name property to be loaded");this.collections.push(t)}getCollection(t){var e,i=this.collections.length;for(e=0;e<i;e+=1)if(this.collections[e].name===t)return this.collections[e];return this.emit("warning","collection "+t+" not found"),null}listCollections(){for(var t=this.collections.length,e=[];t--;)e.push({name:this.collections[t].name,type:this.collections[t].objType,count:this.collections[t].data.length});return e}removeCollection(t){var e,i=this.collections.length;for(e=0;e<i;e+=1)if(this.collections[e].name===t){var n=new o.a(t,{}),r=this.collections[e];for(var s in r)r.hasOwnProperty(s)&&n.hasOwnProperty(s)&&(r[s]=n[s]);return void this.collections.splice(e,1)}}getName(){return this.name}serializeReplacer(t,e){switch(t){case"autosaveHandle":case"persistenceAdapter":case"constraints":case"ttl":return null;default:return e}}serialize(t){switch(t=t||{},t.hasOwnProperty("serializationMethod")||(t.serializationMethod=this.options.serializationMethod),t.serializationMethod){case"normal":return JSON.stringify(this,this.serializeReplacer);case"pretty":return JSON.stringify(this,this.serializeReplacer,2);case"destructured":return this.serializeDestructured();default:return JSON.stringify(this,this.serializeReplacer)}}toJson(){return this.serialize}serializeDestructured(t){var e,i,n,r,s,o=[];if(t=t||{},t.hasOwnProperty("partitioned")||(t.partitioned=!1),t.hasOwnProperty("delimited")||(t.delimited=!0),t.hasOwnProperty("delimiter")||(t.delimiter=this.options.destructureDelimiter),!0===t.partitioned&&t.hasOwnProperty("partition")&&t.partition>=0)return this.serializeCollection({delimited:t.delimited,delimiter:t.delimiter,collectionIndex:t.partition});for(s=new l(this.filename),s.loadJSONObject(this),e=0;e<s.collections.length;e++)s.collections[e].data=[];if(!0===t.partitioned&&-1===t.partition)return s.serialize({serializationMethod:"normal"});for(o.push(s.serialize({serializationMethod:"normal"})),s=null,e=0;e<this.collections.length;e++)if(n=this.serializeCollection({delimited:t.delimited,delimiter:t.delimiter,collectionIndex:e}),!1===t.partitioned&&!1===t.delimited){if(!Array.isArray(n))throw new Error("a nondelimited, non partitioned collection serialization did not return an expected array");for(r=n.length,i=0;i<r;i++)o.push(n[i]),n[i]=null;o.push("")}else o.push(n);return t.partitioned?(t.delimited,o):t.delimited?(o.push(""),o.join(t.delimiter)):(o.push(""),o)}serializeCollection(t){var e,i,n=[];if(t=t||{},t.hasOwnProperty("delimited")||(t.delimited=!0),!t.hasOwnProperty("collectionIndex"))throw new Error("serializeCollection called without 'collectionIndex' option");for(e=this.collections[t.collectionIndex].data.length,n=[],i=0;i<e;i++)n.push(JSON.stringify(this.collections[t.collectionIndex].data[i]));return t.delimited?(n.push(""),n.join(t.delimiter)):n}deserializeDestructured(t,e){var i,n,r,s=[],o=0,a=1,l=!1;if(e=e||{},e.hasOwnProperty("partitioned")||(e.partitioned=!1),e.hasOwnProperty("delimited")||(e.delimited=!0),e.hasOwnProperty("delimiter")||(e.delimiter=this.options.destructureDelimiter),e.partitioned){if(e.hasOwnProperty("partition"))return-1===e.partition?i=JSON.parse(t[0]):this.deserializeCollection(t[e.partition+1],e);for(i=JSON.parse(t[0]),n=i.collections.length,o=0;o<n;o++)i.collections[o].data=this.deserializeCollection(t[o+1],e);return i}if(e.delimited){if(s=t.split(e.delimiter),t=null,0===s.length)return null}else s=t;for(i=JSON.parse(s[0]),n=i.collections.length,s[0]=null;!l;)s[a],""===s[a]?++o>n&&(l=!0):(r=JSON.parse(s[a]),i.collections[o].data.push(r)),s[a++]=null;return i}deserializeCollection(t,e){var i,n,r=[];for(e=e||{},e.hasOwnProperty("partitioned")||(e.partitioned=!1),e.hasOwnProperty("delimited")||(e.delimited=!0),e.hasOwnProperty("delimiter")||(e.delimiter=this.options.destructureDelimiter),e.delimited?(r=t.split(e.delimiter),r.pop()):r=t,n=r.length,i=0;i<n;i++)r[i]=JSON.parse(r[i]);return r}loadJSON(t,e){var i;if(0===t.length)i={};else switch(this.options.serializationMethod){case"normal":case"pretty":i=JSON.parse(t);break;case"destructured":i=this.deserializeDestructured(t);break;default:i=JSON.parse(t)}this.loadJSONObject(i,e)}loadJSONObject(t,e){var i,n,r,s,o,l,h=0,u=t.collections?t.collections.length:0;for(this.name=t.name,this.databaseVersion=1,t.hasOwnProperty("databaseVersion")&&(this.databaseVersion=t.databaseVersion),this.collections=[],h;h<u;h+=1){if(i=t.collections[h],n=this.addCollection(i.name),n.adaptiveBinaryIndices=!!i.hasOwnProperty("adaptiveBinaryIndices")&&!0===i.adaptiveBinaryIndices,n.transactional=i.transactional,n.asyncListeners=i.asyncListeners,n.disableChangesApi=i.disableChangesApi,n.cloneObjects=i.cloneObjects,n.cloneMethod=i.cloneMethod||"parse-stringify",n.autoupdate=i.autoupdate,n.changes=i.changes,e&&!0===e.retainDirtyFlags?n.dirty=i.dirty:n.dirty=!1,r=i.data.length,s=0,e&&e.hasOwnProperty(i.name))for(o=function(t){var i,n=e[t.name];return n.proto?(i=n.inflate||a.a.copyProperties,function(t){var e=new n.proto;return i(t,e),e}):n.inflate}(i),s;s<r;s++)l=o(i.data[s]),n.data[s]=l,n.addAutoUpdateObserver(l);else for(s;s<r;s++)n.data[s]=i.data[s],n.addAutoUpdateObserver(n.data[s]);if(n.maxId=0===i.data.length?0:i.maxId,n.idIndex=i.idIndex,void 0!==i.binaryIndices&&(n.binaryIndices=i.binaryIndices),void 0!==i.transforms&&(n.transforms=i.transforms),n.ensureId(),n.uniqueNames=[],i.hasOwnProperty("uniqueNames"))for(n.uniqueNames=i.uniqueNames,s=0;s<n.uniqueNames.length;s++)n.ensureUniqueIndex(n.uniqueNames[s]);if(void 0!==i.DynamicViews)for(var c=0;c<i.DynamicViews.length;c++){var f=i.DynamicViews[c],d=n.addDynamicView(f.name,f.options);d.resultdata=f.resultdata,d.resultsdirty=f.resultsdirty,d.filterPipeline=f.filterPipeline,d.sortCriteria=f.sortCriteria,d.sortFunction=null,d.sortDirty=f.sortDirty,d.resultset.filteredrows=f.resultset.filteredrows,d.resultset.searchIsChained=f.resultset.searchIsChained,d.resultset.filterInitialized=f.resultset.filterInitialized,d.rematerialize({removeWhereFilters:!0})}}}close(){var t,e=this;return this.autosave&&(this.autosaveDisable(),this.autosaveDirty()&&(t=this.saveDatabase())),Promise.resolve(t).then(function(){e.emit("close")})}generateChangesNotification(t){function e(t){return t.name}var i=[],n=t||this.collections.map(e);return this.collections.forEach(function(t){-1!==n.indexOf(e(t))&&(i=i.concat(t.getChanges()))}),i}serializeChanges(t){return JSON.stringify(this.generateChangesNotification(t))}clearChanges(){this.collections.forEach(function(t){t.flushChanges&&t.flushChanges()})}loadDatabase(t){var e=this;return null===this.persistenceAdapter?Promise.reject(new Error("persistenceAdapter not configured")):Promise.resolve(this.persistenceAdapter.loadDatabase(this.filename)).then(function(i){if("string"==typeof i)e.loadJSON(i,t||{}),e.emit("load",e);else{if("object"!=typeof i||null===i||i instanceof Error){if(i instanceof Error)throw i;throw new TypeError("The persistence adapter did not load a serialized DB string or object.")}e.loadJSONObject(i,t||{}),e.emit("load",e)}})}saveDatabase(){var t=this;if(null===this.persistenceAdapter)return Promise.reject(new Error("persistenceAdapter not configured"));var e;return e="reference"===this.persistenceAdapter.mode&&"function"==typeof this.persistenceAdapter.exportDatabase?this.persistenceAdapter.exportDatabase(this.filename,this.copy({removeNonSerializable:!0})):this.persistenceAdapter.saveDatabase(this.filename,t.serialize()),Promise.resolve(e).then(function(){t.autosaveClearFlags(),t.emit("save")})}save(){return this.saveDatabase()}deleteDatabase(){return null===this.persistenceAdapter?Promise.reject(new Error("persistenceAdapter not configured")):Promise.resolve(this.persistenceAdapter.deleteDatabase(this.filename))}autosaveDirty(){for(var t=0;t<this.collections.length;t++)if(this.collections[t].dirty)return!0;return!1}autosaveClearFlags(){for(var t=0;t<this.collections.length;t++)this.collections[t].dirty=!1}autosaveEnable(){if(!this.autosaveHandle){var t=this,e=!0;this.autosave=!0,this.autosaveHandle=function(){e=!1,t.autosaveHandle=void 0},function i(){setTimeout(function(){e&&t.saveDatabase().then(i,i)},t.autosaveInterval)}()}}autosaveDisable(){this.autosave=!1,this.autosaveHandle&&this.autosaveHandle()}}e.Loki=l,l.Plugins={}}).call(e,i(10))},function(t,e,i){"use strict";function n(t){return"string"==typeof t||Array.isArray(t)?function(e){return-1!==t.indexOf(e)}:"object"==typeof t&&null!==t?function(e){return hasOwnProperty.call(t,e)}:null}function r(t,e){for(var i in e)if(hasOwnProperty.call(e,i))return f[i](t,e[i]);return!1}function s(t,e,n){return t===e?0:i.i(c.a)(t,e,!1)?n?1:-1:i.i(c.b)(t,e,!1)?n?-1:1:0}function o(t,e,i){for(var n,r,o=0,a=0,l=t.length;a<l;a++)if(n=t[a],r=n[0],0!==(o=s(e[r],i[r],n[1])))return o;return 0}function a(t,e,i,n,r){var s=r||0,o=e[s];if(void 0===t||null===t||!hasOwnProperty.call(t,o))return!1;var l=!1,h=t[o];if(s+1>=e.length)l=i(h,n);else if(Array.isArray(h))for(var u=0,c=h.length;u<c&&!0!==(l=a(h[u],e,i,n,s+1));u+=1);else l=a(h,e,i,n,s+1);return l}var l=i(3),h=i(1),u=i(2),c=i(4),f={$eq:function(t,e){return t===e},$aeq:function(t,e){return t==e},$ne:function(t,e){return e!==e?t===t:t!==e},$dteq:function(t,e){return!i.i(c.a)(t,e,!1)&&!i.i(c.b)(t,e,!1)},$gt:function(t,e){return i.i(c.b)(t,e,!1)},$gte:function(t,e){return i.i(c.b)(t,e,!0)},$lt:function(t,e){return i.i(c.a)(t,e,!1)},$lte:function(t,e){return i.i(c.a)(t,e,!0)},$between:function(t,e){return void 0!==t&&null!==t&&(i.i(c.b)(t,e[0],!0)&&i.i(c.a)(t,e[1],!0))},$in:function(t,e){return-1!==e.indexOf(t)},$nin:function(t,e){return-1===e.indexOf(t)},$keyin:function(t,e){return t in e},$nkeyin:function(t,e){return!(t in e)},$definedin:function(t,e){return void 0!==e[t]},$undefinedin:function(t,e){return void 0===e[t]},$regex:function(t,e){return e.test(t)},$containsString:function(t,e){return"string"==typeof t&&-1!==t.indexOf(e)},$containsNone:function(t,e){return!f.$containsAny(t,e)},$containsAny:function(t,e){var i=n(t);return null!==i&&(Array.isArray(e)?e.some(i):i(e))},$contains:function(t,e){var i=n(t);return null!==i&&(Array.isArray(e)?e.every(i):i(e))},$type:function(t,e){var i=typeof t;return"object"===i&&(Array.isArray(t)?i="array":t instanceof Date&&(i="date")),"object"!=typeof e?i===e:r(i,e)},$size:function(t,e){return!!Array.isArray(t)&&("object"!=typeof e?t.length===e:r(t.length,e))},$len:function(t,e){return"string"==typeof t&&("object"!=typeof e?t.length===e:r(t.length,e))},$where:function(t,e){return!0===e(t)},$not:function(t,e){return!r(t,e)},$and:function(t,e){for(var i=0,n=e.length;i<n;i+=1)if(!r(t,e[i]))return!1;return!0},$or:function(t,e){for(var i=0,n=e.length;i<n;i+=1)if(r(t,e[i]))return!0;return!1}},d=["$eq","$aeq","$dteq","$gt","$gte","$lt","$lte","$in","$between"];class p{constructor(t,e){return e=e||{},e.queryObj=e.queryObj||null,e.queryFunc=e.queryFunc||null,e.firstOnly=e.firstOnly||!1,this.collection=t,this.searchIsChained=!e.queryObj&&!e.queryFunc,this.filteredrows=[],this.filterInitialized=!1,void 0!==e.queryObj&&null!==e.queryObj?this.find(e.queryObj,e.firstOnly):void 0!==e.queryFunc&&null!==e.queryFunc?this.where(e.queryFunc):this}reset(){return this.filteredrows.length>0&&(this.filteredrows=[]),this.filterInitialized=!1,this}toJSON(){var t=this.copy();return t.collection=null,t}limit(t){this.searchIsChained&&!this.filterInitialized&&0===this.filteredrows.length&&(this.filteredrows=this.collection.prepareFullDocIndex());var e=new p(this.collection);return e.filteredrows=this.filteredrows.slice(0,t),e.filterInitialized=!0,e}offset(t){this.searchIsChained&&!this.filterInitialized&&0===this.filteredrows.length&&(this.filteredrows=this.collection.prepareFullDocIndex());var e=new p(this.collection);return e.filteredrows=this.filteredrows.slice(t),e.filterInitialized=!0,e}copy(){var t=new p(this.collection);return this.filteredrows.length>0&&(t.filteredrows=this.filteredrows.slice()),t.filterInitialized=this.filterInitialized,t}branch(){return this.copy()}transform(t,e){var i,n,r=this;if("string"==typeof t&&this.collection.transforms.hasOwnProperty(t)&&(t=this.collection.transforms[t]),"object"!=typeof t||!Array.isArray(t))throw new Error("Invalid transform");for(void 0!==e&&(t=u.a.resolveTransformParams(t,e)),i=0;i<t.length;i++)switch(n=t[i],n.type){case"find":r.find(n.value);break;case"where":r.where(n.value);break;case"simplesort":r.simplesort(n.property,n.desc);break;case"compoundsort":r.compoundsort(n.value);break;case"sort":r.sort(n.value);break;case"limit":r=r.limit(n.value);break;case"offset":r=r.offset(n.value);break;case"map":r=r.map(n.value);break;case"eqJoin":r=r.eqJoin(n.joinData,n.leftJoinKey,n.rightJoinKey,n.mapFun);break;case"mapReduce":r=r.mapReduce(n.mapFunction,n.reduceFunction);break;case"update":r.update(n.value);break;case"remove":r.remove()}return r}instance(t){var e,n,r=this.data();t=t||{};var s=new h.a(t);for(e=0;e<r.length;e++)n=this.collection.cloneObjects?r[e]:i.i(l.a)(r[e],this.collection.cloneMethod),delete n.$loki,delete n.meta,s.insert(n);return s}sort(t){this.searchIsChained&&!this.filterInitialized&&0===this.filteredrows.length&&(this.filteredrows=this.collection.prepareFullDocIndex());var e=function(t,e){return function(i,n){return t(e[i],e[n])}}(t,this.collection.data);return this.filteredrows.sort(e),this}simplesort(t,e){if(this.searchIsChained&&!this.filterInitialized&&0===this.filteredrows.length){if(this.collection.binaryIndices.hasOwnProperty(t))return this.collection.ensureIndex(t),this.filteredrows=this.collection.binaryIndices[t].values.slice(0),this;this.filteredrows=this.collection.prepareFullDocIndex()}void 0===e&&(e=!1);var i=function(t,e,i){return function(n,r){return s(i[n][t],i[r][t],e)}}(t,e,this.collection.data);return this.filteredrows.sort(i),this}compoundsort(t){if(0===t.length)throw new Error("Invalid call to compoundsort, need at least one property");var e;if(1===t.length)return e=t[0],Array.isArray(e)?this.simplesort(e[0],e[1]):this.simplesort(e,!1);for(var i=0,n=t.length;i<n;i+=1)e=t[i],Array.isArray(e)||(t[i]=[e,!1]);this.searchIsChained&&!this.filterInitialized&&0===this.filteredrows.length&&(this.filteredrows=this.collection.prepareFullDocIndex());var r=function(t,e){return function(i,n){return o(t,e[i],e[n])}}(t,this.collection.data);return this.filteredrows.sort(r),this}findOr(t){for(var e=null,i=0,n=0,r=[],s=[],o=0,a=this.count(),l=0,h=t.length;l<h;l++){if(e=this.branch().find(t[l]).filteredrows,(n=e.length)===a)return this;for(i=0;i<n;i++)o=e[i],void 0===s[o]&&(s[o]=!0,r.push(o))}return this.filteredrows=r,this.filterInitialized=!0,this}$or(){return this.findOr(...arguments)}findAnd(t){for(var e=0,i=t.length;e<i;e++){if(0===this.count())return this;this.find(t[e])}return this}$and(){return this.findAnd(...arguments)}find(t,e){if(0===this.collection.data.length)return this.searchIsChained?(this.filteredrows=[],this.filterInitialized=!0,this):[];var i,n,r,s,o,l,h=t||"getAll",u=!1,c=[],p=null;if(e=e||!1,"object"==typeof h)for(i in h)if(hasOwnProperty.call(h,i)){n=i,r=h[i];break}if(!n||"getAll"===h)return e?this.collection.data.length>0?this.collection.data[0]:null:this.searchIsChained?this:this.collection.data.slice();if("$and"===n||"$or"===n)return this.searchIsChained?(this[n](r),e&&this.filteredrows.length>1&&(this.filteredrows=this.filteredrows.slice(0,1)),this):(c=this.collection.chain()[n](r).data(),e?0===c.length?[]:c[0]:c);if(null===r||"object"!=typeof r||r instanceof Date)s="$eq",o=r;else{if("object"!=typeof r)throw new Error("Do not know what you want to do.");for(l in r)if(hasOwnProperty.call(r,l)){s=l,o=r[l];break}}if("$regex"===s&&(Array.isArray(o)?o=new RegExp(o[0],o[1]):o instanceof RegExp||(o=new RegExp(o))),t.query){let e=this.collection._fullTextSearch.search(t),i=Object.keys(e),n=[];for(let t=0;t<i.length;t++){let e=parseInt(i[t]);for(let t=0;t<this.collection.data.length;t++)this.collection.data[t].$loki===e&&n.push(this.collection.data[t])}return n}var v=-1!==n.indexOf(".");!(v||this.searchIsChained&&this.filterInitialized)&&this.collection.binaryIndices[n]&&-1!==d.indexOf(s)&&(!0!==this.collection.adaptiveBinaryIndices&&this.collection.ensureIndex(n),u=!0,p=this.collection.binaryIndices[n]);var y=f[s],g=this.collection.data,m=0,w=0;if(!this.searchIsChained){if(u){var b=this.collection.calculateRange(s,n,o);if(e)return-1!==b[1]?g[p.values[b[0]]]:[];if("$in"!==s)for(m=b[0];m<=b[1];m++)c.push(g[p.values[m]]);else for(m=0,w=b.length;m<w;m++)c.push(g[p.values[b[m]]])}else{if(m=g.length,e){if(v){for(n=n.split(".");m--;)if(a(g[m],n,y,o))return g[m]}else for(;m--;)if(y(g[m][n],o))return g[m];return[]}if(v)for(n=n.split(".");m--;)a(g[m],n,y,o)&&c.push(g[m]);else for(;m--;)y(g[m][n],o)&&c.push(g[m])}return c}var I,O=0;if(this.filterInitialized)if(I=this.filteredrows,w=I.length,v)for(n=n.split("."),m=0;m<w;m++)O=I[m],a(g[O],n,y,o)&&c.push(O);else for(m=0;m<w;m++)O=I[m],y(g[O][n],o)&&c.push(O);else{if(u){var x=this.collection.calculateRange(s,n,o);if("$in"!==s)for(m=x[0];m<=x[1];m++)c.push(p.values[m]);else for(m=0,w=x.length;m<w;m++)c.push(p.values[x[m]])}else if(w=g.length,v)for(n=n.split("."),m=0;m<w;m++)a(g[m],n,y,o)&&c.push(m);else for(m=0;m<w;m++)y(g[m][n],o)&&c.push(m);this.filterInitialized=!0}return this.filteredrows=c,this}where(t){var e,i=[];if("function"!=typeof t)throw new TypeError("Argument is not a stored view or a function");e=t;try{if(this.searchIsChained){if(this.filterInitialized){for(var n=this.filteredrows.length;n--;)!0===e(this.collection.data[this.filteredrows[n]])&&i.push(this.filteredrows[n]);return this.filteredrows=i,this}for(var r=this.collection.data.length;r--;)!0===e(this.collection.data[r])&&i.push(r);return this.filteredrows=i,this.filterInitialized=!0,this}for(var s=this.collection.data.length;s--;)!0===e(this.collection.data[s])&&i.push(this.collection.data[s]);return i}catch(t){throw t}}count(){return this.searchIsChained&&this.filterInitialized?this.filteredrows.length:this.collection.count()}data(t){var e,n,r,s=[],o=this.collection.data;if(t=t||{},this.searchIsChained&&!this.filterInitialized){if(0===this.filteredrows.length){if(this.collection.cloneObjects||t.forceClones){for(e=o.length,r=t.forceCloneMethod||this.collection.cloneMethod,n=0;n<e;n++)s.push(i.i(l.a)(o[n],r));return s}return o.slice()}this.filterInitialized=!0}var a=this.filteredrows;if(e=a.length,this.collection.cloneObjects||t.forceClones)for(r=t.forceCloneMethod||this.collection.cloneMethod,n=0;n<e;n++)s.push(i.i(l.a)(o[a[n]],r));else for(n=0;n<e;n++)s.push(o[a[n]]);return s}update(t){if("function"!=typeof t)throw new TypeError("Argument is not a function");this.searchIsChained&&!this.filterInitialized&&0===this.filteredrows.length&&(this.filteredrows=this.collection.prepareFullDocIndex());for(var e=this.filteredrows.length,i=this.collection.data,n=0;n<e;n++)t(i[this.filteredrows[n]]),this.collection.update(i[this.filteredrows[n]]);return this}remove(){return this.searchIsChained&&!this.filterInitialized&&0===this.filteredrows.length&&(this.filteredrows=this.collection.prepareFullDocIndex()),this.collection.remove(this.data()),this.filteredrows=[],this}mapReduce(t,e){try{return e(this.data().map(t))}catch(t){throw t}}eqJoin(t,e,i,n){var r,s,o,a=[],l=[],u=[],c="function"==typeof e,f="function"==typeof i,d={};if(a=this.data(),r=a.length,t instanceof p)l=t.data();else{if(!Array.isArray(t))throw new TypeError("joinData needs to be an array or result set");l=t}s=l.length;for(var v=0;v<s;v++)o=f?i(l[v]):l[v][i],d[o]=l[v];n||(n=function(t,e){return{left:t,right:e}});for(var y=0;y<r;y++)o=c?e(a[y]):a[y][e],u.push(n(a[y],d[o]||{}));return this.collection=new h.a("joinData"),this.collection.insert(u),this.filteredrows=[],this.filterInitialized=!1,this}map(t){var e=this.data().map(t);return this.collection=new h.a("mappedData"),this.collection.insert(e),this.filteredrows=[],this.filterInitialized=!1,this}}e.a=p},function(t,e,i){"use strict";class n{constructor(){this.fs=void 0}loadDatabase(t){var e=this;return new Promise(function(i,n){e.fs.stat(t,function(r,s){!r&&s.isFile()?e.fs.readFile(t,{encoding:"utf8"},function(t,e){t?n(t):i(e)}):n()})})}saveDatabase(t,e){var i=this,n=t+"~";return new Promise(function(r,s){i.fs.writeFile(n,e,function(e){e?s(e):i.fs.rename(n,t,function(t){t?s(t):r()})})})}deleteDatabase(t){var e=this;return new Promise(function(i,n){e.fs.unlink(t,function(t){t?n(t):i()})})}}e.a=n},function(t,e,i){"use strict";function n(){try{return window&&void 0!==window.localStorage&&null!==window.localStorage}catch(t){return!1}}class r{loadDatabase(t){return n()?Promise.resolve(localStorage.getItem(t)):Promise.reject(new Error("localStorage is not available"))}saveDatabase(t,e){return n()?(localStorage.setItem(t,e),Promise.resolve()):Promise.reject(new Error("localStorage is not available"))}deleteDatabase(t){return n()?(localStorage.removeItem(t),Promise.resolve()):Promise.reject(new Error("localStorage is not available"))}}e.a=r},function(t,e,i){"use strict";Object.defineProperty(e,"__esModule",{value:!0});class n{constructor(t){if(this.app="loki",void 0!==t&&(this.app=t),this.catalog=null,!this.checkAvailability())throw new Error("indexedDB does not seem to be supported for your environment")}checkAvailability(){return!("undefined"==typeof indexedDB||!indexedDB)}loadDatabase(t){var e=this.app,i=this;return null===this.catalog||null===this.catalog.db?new Promise(function(e){i.catalog=new r(function(n){i.catalog=n,e(i.loadDatabase(t))})}):new Promise(function(i){this.catalog.getAppKey(e,t,function(t){if(0===t.id)return void i();i(t.val)})})}loadKey(t){return this.loadDatabase(t)}saveDatabase(t,e){function i(t){t&&!0===t.success?n():s(new Error("Error saving database"))}var n,s,o=this.app,a=this,l=new Promise(function(t,e){n=t,s=e});return null===this.catalog||null===this.catalog.db?(this.catalog=new r(function(n){a.catalog=n,n.setAppKey(o,t,e,i)}),l):(this.catalog.setAppKey(o,t,e,i),l)}saveKey(t,e){return this.saveDatabase(t,e)}deleteDatabase(t){var e=this.app,i=this;return null===this.catalog||null===this.catalog.db?new Promise(function(e){i.catalog=new r(function(n){i.catalog=n,e(i.deleteDatabase(t))})}):new Promise(function(n){this.catalog.getAppKey(e,t,function(t){var e=t.id;0!==e&&i.catalog.deleteAppKey(e),n()})})}deleteKey(t){return this.deleteDatabase(t)}deleteDatabasePartitions(t){var e=this;this.getDatabaseList(function(i){i.forEach(function(i){i.startsWith(t)&&e.deleteDatabase(i)})})}getDatabaseList(t){var e=this.app,i=this;if(null===this.catalog||null===this.catalog.db)return void(this.catalog=new r(function(e){i.catalog=e,i.getDatabaseList(t)}));this.catalog.getAppKeys(e,function(e){for(var i=[],n=0;n<e.length;n++)i.push(e[n].key);"function"==typeof t?t(i):i.forEach(function(t){console.log(t)})})}getKeyList(t){return this.getDatabaseList(t)}getCatalogSummary(t){var e=(this.app,this);if(null===this.catalog||null===this.catalog.db)return void(this.catalog=new r(function(i){e.catalog=i,e.getCatalogSummary(t)}));this.catalog.getAllKeys(function(e){for(var i,n,r,s,o,a=[],l=0;l<e.length;l++)i=e[l],r=i.app||"",s=i.key||"",o=i.val||"",n=2*r.length+2*s.length+o.length+1,a.push({app:i.app,key:i.key,size:n});"function"==typeof t?t(a):a.forEach(function(t){console.log(t)})})}}e.LokiIndexedAdapter=n;class r{constructor(t){this.db=null,this.initializeLokiCatalog(t)}initializeLokiCatalog(t){var e=indexedDB.open("LokiCatalog",1),i=this;e.onupgradeneeded=function(t){var e=t.target.result;if(e.objectStoreNames.contains("LokiAKV")&&e.deleteObjectStore("LokiAKV"),!e.objectStoreNames.contains("LokiAKV")){var i=e.createObjectStore("LokiAKV",{keyPath:"id",autoIncrement:!0});i.createIndex("app","app",{unique:!1}),i.createIndex("key","key",{unique:!1}),i.createIndex("appkey","appkey",{unique:!0})}},e.onsuccess=function(e){i.db=e.target.result,"function"==typeof t&&t(i)},e.onerror=function(t){throw t}}getAppKey(t,e,i){var n=this.db.transaction(["LokiAKV"],"readonly"),r=n.objectStore("LokiAKV"),s=r.index("appkey"),o=t+","+e,a=s.get(o);a.onsuccess=function(t){return function(e){var i=e.target.result;null!==i&&void 0!==i||(i={id:0,success:!1}),"function"==typeof t?t(i):console.log(i)}}(i),a.onerror=function(t){return function(e){if("function"!=typeof t)throw e;t({id:0,success:!1})}}(i)}getAppKeyById(t,e,i){this.db.transaction(["LokiAKV"],"readonly").objectStore("LokiAKV").get(t).onsuccess=function(t,e){return function(i){"function"==typeof e?e(i.target.result,t):console.log(i.target.result)}}(i,e)}setAppKey(t,e,i,n){var r=this.db.transaction(["LokiAKV"],"readwrite"),s=r.objectStore("LokiAKV"),o=s.index("appkey"),a=t+","+e,l=o.get(a);l.onsuccess=function(r){var o=r.target.result;null===o||void 0===o?o={app:t,key:e,appkey:t+","+e,val:i}:o.val=i;var a=s.put(o);a.onerror=function(t){return function(e){"function"==typeof t?t({success:!1}):(console.error("LokiCatalog.setAppKey (set) onerror"),console.error(l.error))}}(n),a.onsuccess=function(t){return function(e){"function"==typeof t&&t({success:!0})}}(n)},l.onerror=function(t){return function(e){"function"==typeof t?t({success:!1}):(console.error("LokiCatalog.setAppKey (get) onerror"),console.error(l.error))}}(n)}deleteAppKey(t,e){var i=this.db.transaction(["LokiAKV"],"readwrite"),n=i.objectStore("LokiAKV"),r=n.delete(t);r.onsuccess=function(t){return function(e){"function"==typeof t&&t({success:!0})}}(e),r.onerror=function(t){return function(e){"function"==typeof t?t(!1):(console.error("LokiCatalog.deleteAppKey raised onerror"),console.error(r.error))}}(e)}getAppKeys(t,e){var i=this.db.transaction(["LokiAKV"],"readonly"),n=i.objectStore("LokiAKV"),r=n.index("app"),s=IDBKeyRange.only(t),o=r.openCursor(s),a=[];o.onsuccess=function(t,e){return function(i){var n=i.target.result;if(n){var r=n.value;t.push(r),n.continue()}else"function"==typeof e?e(t):console.log(t)}}(a,e),o.onerror=function(t){return function(e){"function"==typeof t?t(null):(console.error("LokiCatalog.getAppKeys raised onerror"),console.error(e))}}(e)}getAllKeys(t){var e=this.db.transaction(["LokiAKV"],"readonly"),i=e.objectStore("LokiAKV"),n=i.openCursor(),r=[];n.onsuccess=function(t,e){return function(i){var n=i.target.result;if(n){var r=n.value;t.push(r),n.continue()}else"function"==typeof e?e(t):console.log(t)}}(r,t),n.onerror=function(t){return function(e){"function"==typeof t&&t(null)}}(t)}}},function(t,e){var i;i=function(){return this}();try{i=i||Function("return this")()||(0,eval)("this")}catch(t){"object"==typeof window&&(i=window)}t.exports=i},function(t,e,i){"use strict";var n=i(0),r=i(6);class s extends n.a{constructor(t,e,i){super(),this.collection=t,this.name=e,this.rebuildPending=!1,this.options=i||{},this.options.hasOwnProperty("persistent")||(this.options.persistent=!1),this.options.hasOwnProperty("sortPriority")||(this.options.sortPriority="passive"),this.options.hasOwnProperty("minRebuildInterval")||(this.options.minRebuildInterval=1),this.resultset=new r.a(t),this.resultdata=[],this.resultsdirty=!1,this.cachedresultset=null,this.filterPipeline=[],this.sortFunction=null,this.sortCriteria=null,this.sortDirty=!1,this.events={rebuild:[]}}rematerialize(t){var e,i,n;if(t=t||{},this.resultdata=[],this.resultsdirty=!0,this.resultset=new r.a(this.collection),(this.sortFunction||this.sortCriteria)&&(this.sortDirty=!0),t.hasOwnProperty("removeWhereFilters"))for(e=this.filterPipeline.length,i=e;i--;)"where"===this.filterPipeline[i].type&&(i!==this.filterPipeline.length-1&&(this.filterPipeline[i]=this.filterPipeline[this.filterPipeline.length-1]),this.filterPipeline.length--);var s=this.filterPipeline;for(this.filterPipeline=[],e=s.length,n=0;n<e;n++)this.applyFind(s[n].val);return this.data(),this.emit("rebuild",this),this}branchResultset(t,e){var i=this.resultset.branch();return void 0===t?i:i.transform(t,e)}toJSON(){var t=new s(this.collection,this.name,this.options);return t.resultset=this.resultset,t.resultdata=[],t.resultsdirty=!0,t.filterPipeline=this.filterPipeline,t.sortFunction=this.sortFunction,t.sortCriteria=this.sortCriteria,t.sortDirty=this.sortDirty,t.collection=null,t}removeFilters(t){t=t||{},this.rebuildPending=!1,this.resultset.reset(),this.resultdata=[],this.resultsdirty=!0,this.cachedresultset=null,this.filterPipeline=[],this.sortFunction=null,this.sortCriteria=null,this.sortDirty=!1,!0===t.queueSortPhase&&this.queueSortPhase()}applySort(t){return this.sortFunction=t,this.sortCriteria=null,this.queueSortPhase(),this}applySimpleSort(t,e){return this.sortCriteria=[[t,e||!1]],this.sortFunction=null,this.queueSortPhase(),this}applySortCriteria(t){return this.sortCriteria=t,this.sortFunction=null,this.queueSortPhase(),this}startTransaction(){return this.cachedresultset=this.resultset.copy(),this}commit(){return this.cachedresultset=null,this}rollback(){return this.resultset=this.cachedresultset,this.options.persistent&&(this.resultdata=this.resultset.data(),this.emit("rebuild",this)),this}_indexOfFilterWithId(t){if("string"==typeof t||"number"==typeof t)for(var e=0,i=this.filterPipeline.length;e<i;e+=1)if(t===this.filterPipeline[e].uid)return e;return-1}_addFilter(t){this.filterPipeline.push(t),this.resultset[t.type](t.val)}reapplyFilters(){this.resultset.reset(),this.cachedresultset=null,this.options.persistent&&(this.resultdata=[],this.resultsdirty=!0);var t=this.filterPipeline;this.filterPipeline=[];for(var e=0,i=t.length;e<i;e+=1)this._addFilter(t[e]);return this.sortFunction||this.sortCriteria?this.queueSortPhase():this.queueRebuildEvent(),this}applyFilter(t){var e=this._indexOfFilterWithId(t.uid);return e>=0?(this.filterPipeline[e]=t,this.reapplyFilters()):(this.cachedresultset=null,this.options.persistent&&(this.resultdata=[],this.resultsdirty=!0),this._addFilter(t),this.sortFunction||this.sortCriteria?this.queueSortPhase():this.queueRebuildEvent(),this)}applyFind(t,e){return this.applyFilter({type:"find",val:t,uid:e}),this}applyWhere(t,e){return this.applyFilter({type:"where",val:t,uid:e}),this}removeFilter(t){var e=this._indexOfFilterWithId(t);if(e<0)throw new Error("Dynamic view does not contain a filter with ID: "+t);return this.filterPipeline.splice(e,1),this.reapplyFilters(),this}count(){return this.resultsdirty&&(this.resultdata=this.resultset.data()),this.resultset.count()}data(){return(this.sortDirty||this.resultsdirty)&&this.performSortPhase({suppressRebuildEvent:!0}),this.options.persistent?this.resultdata:this.resultset.data()}queueRebuildEvent(){if(!this.rebuildPending){this.rebuildPending=!0;var t=this;setTimeout(function(){t.rebuildPending&&(t.rebuildPending=!1,t.emit("rebuild",t))},this.options.minRebuildInterval)}}queueSortPhase(){if(!this.sortDirty){this.sortDirty=!0;var t=this;"active"===this.options.sortPriority?setTimeout(function(){t.performSortPhase()},this.options.minRebuildInterval):this.queueRebuildEvent()}}performSortPhase(t){(this.sortDirty||this.resultsdirty)&&(t=t||{},this.sortDirty&&(this.sortFunction?this.resultset.sort(this.sortFunction):this.sortCriteria&&this.resultset.compoundsort(this.sortCriteria),this.sortDirty=!1),this.options.persistent&&(this.resultdata=this.resultset.data(),this.resultsdirty=!1),t.suppressRebuildEvent||this.emit("rebuild",this))}evaluateDocument(t,e){if(!this.resultset.filterInitialized)return this.options.persistent&&(this.resultdata=this.resultset.data()),void(this.sortFunction||this.sortCriteria?this.queueSortPhase():this.queueRebuildEvent());var i=this.resultset.filteredrows,n=e?-1:i.indexOf(+t),s=i.length,o=new r.a(this.collection);o.filteredrows=[t],o.filterInitialized=!0;for(var a,l=0,h=this.filterPipeline.length;l<h;l++)a=this.filterPipeline[l],o[a.type](a.val);var u=0===o.filteredrows.length?-1:0;return-1!==n||-1!==u?-1===n&&-1!==u?(i.push(t),this.options.persistent&&this.resultdata.push(this.collection.data[t]),void(this.sortFunction||this.sortCriteria?this.queueSortPhase():this.queueRebuildEvent())):-1!==n&&-1===u?(n<s-1?(i.splice(n,1),this.options.persistent&&this.resultdata.splice(n,1)):(i.length=s-1,this.options.persistent&&(this.resultdata.length=s-1)),void(this.sortFunction||this.sortCriteria?this.queueSortPhase():this.queueRebuildEvent())):-1!==n&&-1!==u?(this.options.persistent&&(this.resultdata[n]=this.collection.data[t]),void(this.sortFunction||this.sortCriteria?this.queueSortPhase():this.queueRebuildEvent())):void 0:void 0}removeDocument(t){if(!this.resultset.filterInitialized)return this.options.persistent&&(this.resultdata=this.resultset.data()),void(this.sortFunction||this.sortCriteria?this.queueSortPhase():this.queueRebuildEvent());var e,i=this.resultset.filteredrows,n=i.indexOf(+t),r=i.length;for(-1!==n&&(n<r-1?(i[n]=i[r-1],i.length=r-1,this.options.persistent&&(this.resultdata[n]=this.resultdata[r-1],this.resultdata.length=r-1)):(i.length=r-1,this.options.persistent&&(this.resultdata.length=r-1)),this.sortFunction||this.sortCriteria?this.queueSortPhase():this.queueRebuildEvent()),r=i.length,e=0;e<r;e++)i[e]>t&&i[e]--}mapReduce(t,e){try{return e(this.data().map(t))}catch(t){throw t}}}e.a=s},function(t,e,i){"use strict";class n{constructor(t){this.index={},this.field=t}set(t,e){this.index[t]?this.index[t].push(e):this.index[t]=[e],console.log("?")}remove(t,e){var i=this.index[t];for(var n in i)i[n]==e&&i.splice(n,1);i.length<1&&(this.index[t]=void 0)}get(t){return console.log("!"),this.index[t]}clear(t){this.index={}}}e.a=n},function(t,e,i){"use strict";class n{constructor(t){this.field=t,this.keyMap={},this.lokiMap={}}set(t){var e=t[this.field];if(null!==e&&void 0!==e){if(this.keyMap[e])throw new Error("Duplicate key for property "+this.field+": "+e);this.keyMap[e]=t,this.lokiMap[t.$loki]=e}}get(t){return this.keyMap[t]}byId(t){return this.keyMap[this.lokiMap[t]]}update(t,e){if(this.lokiMap[t.$loki]!==e[this.field]){var i=this.lokiMap[t.$loki];this.set(e),this.keyMap[i]=void 0}else this.keyMap[t[this.field]]=e}remove(t){var e=this.keyMap[t];if(null===e||void 0===e)throw new Error("Key is not in unique index: "+this.field);this.keyMap[t]=void 0,this.lokiMap[e.$loki]=void 0}clear(){this.keyMap={},this.lokiMap={}}}e.a=n}])});
//# sourceMappingURL=loki.min.js.map