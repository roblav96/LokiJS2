!function(t,e){"object"==typeof exports&&"object"==typeof module?module.exports=e(require("fs")):"function"==typeof define&&define.amd?define("loki",["fs"],e):"object"==typeof exports?exports.loki=e(require("fs")):(t.lokijs=t.lokijs||{},t.lokijs.loki=e(t.fs))}(this,function(t){return function(t){function e(n){if(i[n])return i[n].exports;var r=i[n]={exports:{},id:n,loaded:!1};return t[n].call(r.exports,r,r.exports,e),r.loaded=!0,r.exports}var i={};return e.m=t,e.c=i,e.p="",e(0)}({0:function(t,e,i){var n,r,s;(function(o){"use strict";!function(i,o){r=[],n=o,s="function"==typeof n?n.apply(e,r):n,!(void 0!==s&&(t.exports=s))}(void 0,function(){return function(){function t(t,e,i){var n,r;if(!t||!e||t===!0||e===!0){if(!(t!==!0&&t!==!1||e!==!0&&e!==!1))return i?t===e:!t&&e;if(void 0===e||null===e||t===!0||e===!1)return i;if(void 0===t||null===t||t===!1||e===!0)return!0}return t===e?i:t<e||!(t>e)&&(n=t.toString(),r=e.toString(),n==r?i:n<r)}function e(t,e,i){var n,r;if(!t||!e||t===!0||e===!0){if(!(t!==!0&&t!==!1||e!==!0&&e!==!1))return i?t===e:!!t&&!e;if(void 0===t||null===t||t===!1||e===!0)return i;if(void 0===e||null===e||t===!0||e===!1)return!0}return t===e?i:t>e||!(t<e)&&(n=t.toString(),r=e.toString(),n==r?i:n>r)}function n(i,n,r){return i===n?0:t(i,n,!1)?r?1:-1:e(i,n,!1)?r?-1:1:0}function r(t,e,i){for(var r,s,o=0,a=0,h=t.length;a<h;a++)if(r=t[a],s=r[0],o=n(e[s],i[s],r[1]),0!==o)return o;return 0}function s(t,e,i,n,r){var o=r||0,a=e[o];if(void 0===t||null===t||!E.call(t,a))return!1;var h=!1,l=t[a];if(o+1>=e.length)h=i(l,n);else if(Array.isArray(l))for(var u=0,c=l.length;u<c&&(h=s(l[u],e,i,n,o+1),h!==!0);u+=1);else h=s(l,e,i,n,o+1);return h}function a(t){return"string"==typeof t||Array.isArray(t)?function(e){return t.indexOf(e)!==-1}:"object"==typeof t&&null!==t?function(e){return E.call(t,e)}:null}function h(t,e){for(var i in e)if(E.call(e,i))return F[i](t,e[i]);return!1}function l(t,e){var i,n=e||"parse-stringify";switch(n){case"parse-stringify":i=JSON.parse(JSON.stringify(t));break;case"jquery-extend-deep":i=jQuery.extend(!0,{},t);break;case"shallow":i=Object.create(t.prototype||null),Object.keys(t).map(function(e){i[e]=t[e]})}return i}function u(t,e){var i,n=[];if("parse-stringify"==e)return l(t,e);for(i=t.length-1;i<=0;i--)n.push(l(t[i],e));return n}function c(){try{return window&&void 0!==window.localStorage&&null!==window.localStorage}catch(t){return!1}}function f(){}function p(t,e){this.filename=t||"loki.db",this.collections=[],this.databaseVersion=1.1,this.engineVersion=1.1,this.autosave=!1,this.autosaveInterval=5e3,this.autosaveHandle=null,this.options={},this.persistenceMethod=null,this.persistenceAdapter=null,this.verbose=!(!e||!e.hasOwnProperty("verbose"))&&e.verbose,this.events={init:[],loaded:[],flushChanges:[],close:[],changes:[],warning:[]};var i=function(){return"undefined"==typeof window?"NODEJS":"undefined"!=typeof o&&o.window?"NODEJS":"undefined"!=typeof document?document.URL.indexOf("http://")===-1&&document.URL.indexOf("https://")===-1?"CORDOVA":"BROWSER":"CORDOVA"};e&&e.hasOwnProperty("env")?this.ENV=e.env:this.ENV=i(),this.on("init",this.clearChanges)}function d(){this.fs=i(14)}function y(){}function v(t,e){return e=e||{},e.queryObj=e.queryObj||null,e.queryFunc=e.queryFunc||null,e.firstOnly=e.firstOnly||!1,this.collection=t,this.searchIsChained=!e.queryObj&&!e.queryFunc,this.filteredrows=[],this.filterInitialized=!1,"undefined"!=typeof e.queryObj&&null!==e.queryObj?this.find(e.queryObj,e.firstOnly):"undefined"!=typeof e.queryFunc&&null!==e.queryFunc?this.where(e.queryFunc):this}function m(t,e,i){this.collection=t,this.name=e,this.rebuildPending=!1,this.options=i||{},this.options.hasOwnProperty("persistent")||(this.options.persistent=!1),this.options.hasOwnProperty("sortPriority")||(this.options.sortPriority="passive"),this.options.hasOwnProperty("minRebuildInterval")||(this.options.minRebuildInterval=1),this.resultset=new v(t),this.resultdata=[],this.resultsdirty=!1,this.cachedresultset=null,this.filterPipeline=[],this.sortFunction=null,this.sortCriteria=null,this.sortDirty=!1,this.events={rebuild:[]}}function g(t,e){function i(t){var e="function"==typeof Set?new Set:[];e.add||(e.add=function(t){return this.indexOf(t)===-1&&this.push(t),this}),t.forEach(function(t){e.add(t.object)}),e.forEach(function(t){if(!E.call(t,"$loki"))return f.removeAutoUpdateObserver(t);try{f.update(t)}catch(t){}})}function n(t,e,i){f.changes.push({name:t,operation:e,obj:JSON.parse(JSON.stringify(i))})}function r(){f.changes=[]}function s(t){t&&(t.meta||(t.meta={}),t.meta.created=(new Date).getTime(),t.meta.revision=0)}function o(t){t&&(t.meta.updated=(new Date).getTime(),t.meta.revision+=1)}function a(t){n(f.name,"I",t)}function h(t){n(f.name,"U",t)}function l(t){s(t),a(t)}function u(t){o(t),h(t)}function c(){y=f.disableChangesApi?s:l,v=f.disableChangesApi?o:u}this.name=t,this.data=[],this.idIndex=[],this.binaryIndices={},this.constraints={unique:{},exact:{}},this.uniqueNames=[],this.transforms={},this.objType=t,this.dirty=!0,this.cachedIndex=null,this.cachedBinaryIndex=null,this.cachedData=null;var f=this;e=e||{},e.hasOwnProperty("unique")&&(Array.isArray(e.unique)||(e.unique=[e.unique]),e.unique.forEach(function(t){f.uniqueNames.push(t),f.constraints.unique[t]=new j(t)})),e.hasOwnProperty("exact")&&e.exact.forEach(function(t){f.constraints.exact[t]=new C(t)}),this.adaptiveBinaryIndices=!e.hasOwnProperty("adaptiveBinaryIndices")||e.adaptiveBinaryIndices,this.transactional=!!e.hasOwnProperty("transactional")&&e.transactional,this.cloneObjects=!!e.hasOwnProperty("clone")&&e.clone,this.cloneMethod=e.hasOwnProperty("cloneMethod")?e.cloneMethod:"parse-stringify",this.asyncListeners=!!e.hasOwnProperty("asyncListeners")&&e.asyncListeners,this.disableChangesApi=!e.hasOwnProperty("disableChangesApi")||e.disableChangesApi,this.autoupdate=!!e.hasOwnProperty("autoupdate")&&e.autoupdate,this.ttl={age:null,ttlInterval:null,daemon:null},this.setTTL(e.ttl||-1,e.ttlInterval),this.maxId=0,this.DynamicViews=[],this.events={insert:[],update:[],"pre-insert":[],"pre-update":[],close:[],flushbuffer:[],error:[],delete:[],warning:[]},this.changes=[],this.ensureId();var p=[];if(e&&e.indices)if("[object Array]"===Object.prototype.toString.call(e.indices))p=e.indices;else{if("string"!=typeof e.indices)throw new TypeError("Indices needs to be a string or an array of strings");p=[e.indices]}for(var d=0;d<p.length;d++)this.ensureIndex(p[d]);this.observerCallback=i,this.getChanges=function(){return f.changes},this.flushChanges=r;var y,v;c(),this.setChangesApi=function(t){f.disableChangesApi=!t,c()},this.on("insert",function(t){y(t)}),this.on("update",function(t){v(t)}),this.on("delete",function(t){f.disableChangesApi||n(f.name,"R",t)}),this.on("warning",function(t){f.console.warn(t)}),r()}function w(t){return t.indexOf(".")!==-1}function b(t){return parseFloat(t,10)}function I(t,e){return t+e}function x(t,e){return t-e}function O(t){return t.reduce(I,0)/t.length}function D(t){var e=O(t),i=t.map(function(t){var i=t-e,n=i*i;return n}),n=O(i),r=Math.sqrt(n);return r}function P(t,e,i){if(i===!1)return t[e];for(var n=e.split("."),r=t;n.length>0;)r=r[n.shift()];return r}function k(t,e,i){for(var n,r,s=0,o=t.length;s<o;){if(r=s+o>>1,n=i.apply(null,[e,t[r]]),0===n)return{found:!0,index:r};n<0?o=r:s=r+1}return{found:!1,index:o}}function A(t){return function(e,i){return k(e,i,t)}}function q(){}function j(t){this.field=t,this.keyMap={},this.lokiMap={}}function C(t){this.index={},this.field=t}function $(t){this.field=t}var E=Object.prototype.hasOwnProperty,S={copyProperties:function(t,e){var i;for(i in t)e[i]=t[i]},resolveTransformObject:function(t,e,i){var n,r;if("number"!=typeof i&&(i=0),++i>=10)return t;for(n in t)"string"==typeof t[n]&&0===t[n].indexOf("[%lktxp]")?(r=t[n].substring(8),e.hasOwnProperty(r)&&(t[n]=e[r])):"object"==typeof t[n]&&(t[n]=S.resolveTransformObject(t[n],e,i));return t},resolveTransformParams:function(t,e){var i,n,r=[];if("undefined"==typeof e)return t;for(i=0;i<t.length;i++)n=JSON.parse(JSON.stringify(t[i])),r.push(S.resolveTransformObject(n,e));return r}},F={$eq:function(t,e){return t===e},$aeq:function(t,e){return t==e},$ne:function(t,e){return e!==e?t===t:t!==e},$dteq:function(i,n){return!t(i,n,!1)&&!e(i,n,!1)},$gt:function(t,i){return e(t,i,!1)},$gte:function(t,i){return e(t,i,!0)},$lt:function(e,i){return t(e,i,!1)},$lte:function(e,i){return t(e,i,!0)},$in:function(t,e){return e.indexOf(t)!==-1},$nin:function(t,e){return e.indexOf(t)===-1},$keyin:function(t,e){return t in e},$nkeyin:function(t,e){return!(t in e)},$definedin:function(t,e){return void 0!==e[t]},$undefinedin:function(t,e){return void 0===e[t]},$regex:function(t,e){return e.test(t)},$containsString:function(t,e){return"string"==typeof t&&t.indexOf(e)!==-1},$containsNone:function(t,e){return!F.$containsAny(t,e)},$containsAny:function(t,e){var i=a(t);return null!==i&&(Array.isArray(e)?e.some(i):i(e))},$contains:function(t,e){var i=a(t);return null!==i&&(Array.isArray(e)?e.every(i):i(e))},$type:function(t,e){var i=typeof t;return"object"===i&&(Array.isArray(t)?i="array":t instanceof Date&&(i="date")),"object"!=typeof e?i===e:h(i,e)},$size:function(t,e){return!!Array.isArray(t)&&("object"!=typeof e?t.length===e:h(t.length,e))},$len:function(t,e){return"string"==typeof t&&("object"!=typeof e?t.length===e:h(t.length,e))},$where:function(t,e){return e(t)===!0},$not:function(t,e){return!h(t,e)},$and:function(t,e){for(var i=0,n=e.length;i<n;i+=1)if(!h(t,e[i]))return!1;return!0},$or:function(t,e){for(var i=0,n=e.length;i<n;i+=1)if(h(t,e[i]))return!0;return!1}},M=["$eq","$aeq","$dteq","$gt","$gte","$lt","$lte"];return f.prototype.events={},f.prototype.asyncListeners=!1,f.prototype.on=function(t,e){var i,n=this;return Array.isArray(t)?(t.forEach(function(t){n.on(t,e)}),e):(i=this.events[t],i||(i=this.events[t]=[]),i.push(e),e)},f.prototype.emit=function(t,e){var i=this;t&&this.events[t]&&this.events[t].forEach(function(t){i.asyncListeners?setTimeout(function(){t(e)},1):t(e)})},f.prototype.removeListener=function(t,e){var i=this;if(Array.isArray(t)&&t.forEach(function(t){i.removeListener(t,listen)}),this.events[t]){var n=this.events[t];n.splice(n.indexOf(e),1)}},p.prototype=new f,p.prototype.getIndexedAdapter=function(){var t;return t=i(!function(){var t=new Error('Cannot find module "./loki-indexed-adapter.js"');throw t.code="MODULE_NOT_FOUND",t}())},p.prototype.initializePersistence=function(t){var e=this,i={NODEJS:"fs",BROWSER:"localStorage",CORDOVA:"localStorage"},n={fs:d,localStorage:y};this.options=t||{},this.persistenceMethod=null,this.persistenceAdapter=null,this.options.hasOwnProperty("persistenceMethod")&&"function"==typeof n[this.options.persistenceMethod]&&(this.persistenceMethod=this.options.persistenceMethod,this.persistenceAdapter=new n[this.options.persistenceMethod]),null===this.persistenceAdapter&&(this.persistenceMethod=i[this.ENV],this.persistenceMethod&&(this.persistenceAdapter=new n[this.persistenceMethod])),this.options.hasOwnProperty("adapter")&&(this.persistenceMethod="adapter",this.persistenceAdapter=this.options.adapter),this.options.hasOwnProperty("autosaveInterval")&&(this.autosaveInterval=parseInt(this.options.autosaveInterval,10)),this.autosaveDisable();var r;return r=this.options.autoload?this.loadDatabase(this.options.inflate):Promise.resolve(),r.then(function(){e.options.autosave&&e.autosaveEnable()})},p.prototype.anonym=function(t,e){var i=new g("anonym",e);return i.insert(t),this.verbose&&(i.console=console),i},p.prototype.addCollection=function(t,e){var i=new g(t,e);return this.collections.push(i),this.verbose&&(i.console=console),i},p.prototype.loadCollection=function(t){if(!t.name)throw new Error("Collection must have a name property to be loaded");this.collections.push(t)},p.prototype.getCollection=function(t){var e,i=this.collections.length;for(e=0;e<i;e+=1)if(this.collections[e].name===t)return this.collections[e];return this.emit("warning","collection "+t+" not found"),null},p.prototype.listCollections=function(){for(var t=this.collections.length,e=[];t--;)e.push({name:this.collections[t].name,type:this.collections[t].objType,count:this.collections[t].data.length});return e},p.prototype.removeCollection=function(t){var e,i=this.collections.length;for(e=0;e<i;e+=1)if(this.collections[e].name===t){var n=new g(t,{}),r=this.collections[e];for(var s in r)r.hasOwnProperty(s)&&n.hasOwnProperty(s)&&(r[s]=n[s]);return void this.collections.splice(e,1)}},p.prototype.getName=function(){return this.name},p.prototype.serializeReplacer=function(t,e){switch(t){case"autosaveHandle":case"persistenceAdapter":case"constraints":case"ttl":return null;default:return e}},p.prototype.serialize=function(){return JSON.stringify(this,this.serializeReplacer,2)},p.prototype.toJson=p.prototype.serialize,p.prototype.loadJSON=function(t,e){var i;i=0===t.length?{}:JSON.parse(t),this.loadJSONObject(i,e)},p.prototype.loadJSONObject=function(t,e){function i(t){var i,n=e[t.name];return n.proto?(i=n.inflate||S.copyProperties,function(t){var e=new n.proto;return i(t,e),e}):n.inflate}var n,r,s,o,a,h,l=0,u=t.collections?t.collections.length:0;for(this.name=t.name,this.databaseVersion=1,t.hasOwnProperty("databaseVersion")&&(this.databaseVersion=t.databaseVersion),this.collections=[],l;l<u;l+=1){if(n=t.collections[l],r=this.addCollection(n.name),r.adaptiveBinaryIndices=!!n.hasOwnProperty("adaptiveBinaryIndices")&&n.adaptiveBinaryIndices===!0,r.transactional=n.transactional,r.asyncListeners=n.asyncListeners,r.disableChangesApi=n.disableChangesApi,r.cloneObjects=n.cloneObjects,r.cloneMethod=n.cloneMethod||"parse-stringify",r.autoupdate=n.autoupdate,s=n.data.length,o=0,e&&e.hasOwnProperty(n.name))for(a=i(n),o;o<s;o++)h=a(n.data[o]),r.data[o]=h,r.addAutoUpdateObserver(h);else for(o;o<s;o++)r.data[o]=n.data[o],r.addAutoUpdateObserver(r.data[o]);if(r.maxId=0===n.data.length?0:n.maxId,r.idIndex=n.idIndex,"undefined"!=typeof n.binaryIndices&&(r.binaryIndices=n.binaryIndices),"undefined"!=typeof n.transforms&&(r.transforms=n.transforms),r.ensureId(),r.uniqueNames=[],n.hasOwnProperty("uniqueNames"))for(r.uniqueNames=n.uniqueNames,o=0;o<r.uniqueNames.length;o++)r.ensureUniqueIndex(r.uniqueNames[o]);if("undefined"!=typeof n.DynamicViews)for(var c=0;c<n.DynamicViews.length;c++){var f=n.DynamicViews[c],p=r.addDynamicView(f.name,f.options);p.resultdata=f.resultdata,p.resultsdirty=f.resultsdirty,p.filterPipeline=f.filterPipeline,p.sortCriteria=f.sortCriteria,p.sortFunction=null,p.sortDirty=f.sortDirty,p.resultset.filteredrows=f.resultset.filteredrows,p.resultset.searchIsChained=f.resultset.searchIsChained,p.resultset.filterInitialized=f.resultset.filterInitialized,p.rematerialize({removeWhereFilters:!0})}}},p.prototype.close=function(){var t,e=this;return this.autosave&&(this.autosaveDisable(),this.autosaveDirty()&&(t=this.saveDatabase())),t||(t=Promise.resolve()),t.then(function(){e.emit("close")})},p.prototype.generateChangesNotification=function(t){function e(t){return t.name}var i=[],n=t||this.collections.map(e);return this.collections.forEach(function(t){n.indexOf(e(t))!==-1&&(i=i.concat(t.getChanges()))}),i},p.prototype.serializeChanges=function(t){return JSON.stringify(this.generateChangesNotification(t))},p.prototype.clearChanges=function(){this.collections.forEach(function(t){t.flushChanges&&t.flushChanges()})},d.prototype.loadDatabase=function(t){var e=this;return new Promise(function(i,n){e.fs.stat(t,function(r,s){!r&&s.isFile()?e.fs.readFile(t,{encoding:"utf8"},function(t,e){t?n(t):i(e)}):n()})})},d.prototype.saveDatabase=function(t,e){var i=this;return new Promise(function(n,r){i.fs.writeFile(t,e,function(t){t?r(t):n()})})},d.prototype.deleteDatabase=function(t,e){var i=this;return new Promise(function(e,n){i.fs.unlink(t,function(t){t?n(t):e()})})},y.prototype.loadDatabase=function(t){return c()?Promise.resolve(localStorage.getItem(t)):Promise.reject(new Error("localStorage is not available"))},y.prototype.saveDatabase=function(t,e){return c()?(localStorage.setItem(t,e),Promise.resolve()):Promise.reject(new Error("localStorage is not available"))},y.prototype.deleteDatabase=function(t){return c()?(localStorage.removeItem(t),Promise.resolve()):Promise.reject(new Error("localStorage is not available"))},p.prototype.loadDatabase=function(t){var e=this;return null===this.persistenceAdapter?Promise.reject(new Error("persistenceAdapter not configured")):this.persistenceAdapter.loadDatabase(this.filename).then(function(i){if("string"==typeof i)e.loadJSON(i,t||{}),e.emit("load",e);else{if("object"!=typeof i||null===i||i instanceof Error){if(i instanceof Error)throw i;throw new TypeError("The persistence adapter did not load a serialized DB string or object.")}e.loadJSONObject(i,t||{}),e.emit("load",e)}})},p.prototype.saveDatabase=function(){var t=this;if(null===this.persistenceAdapter)return Promise.reject(new Error("persistenceAdapter not configured"));var e;return e="reference"===this.persistenceAdapter.mode&&"function"==typeof this.persistenceAdapter.exportDatabase?this.persistenceAdapter.exportDatabase(this.filename,this):this.persistenceAdapter.saveDatabase(this.filename,t.serialize()),e.then(function(){t.autosaveClearFlags(),t.emit("save")})},p.prototype.save=p.prototype.saveDatabase,p.prototype.deleteDatabase=function(){return null===this.persistenceAdapter?Promise.reject(new Error("persistenceAdapter not configured")):this.persistenceAdapter.deleteDatabase(this.filename)},p.prototype.autosaveDirty=function(){for(var t=0;t<this.collections.length;t++)if(this.collections[t].dirty)return!0;return!1},p.prototype.autosaveClearFlags=function(){for(var t=0;t<this.collections.length;t++)this.collections[t].dirty=!1},p.prototype.autosaveEnable=function(){if(!this.autosaveHandle){var t=this,e=!0;this.autosave=!0,this.autosaveHandle=function(){e=!1,t.autosaveHandle=void 0},function i(){setTimeout(function(){e&&t.saveDatabase().then(i,i)},t.autosaveInterval)}()}},p.prototype.autosaveDisable=function(){this.autosave=!1,this.autosaveHandle&&this.autosaveHandle()},v.prototype.reset=function(){return this.filteredrows.length>0&&(this.filteredrows=[]),this.filterInitialized=!1,this},v.prototype.toJSON=function(){var t=this.copy();return t.collection=null,t},v.prototype.limit=function(t){this.searchIsChained&&!this.filterInitialized&&0===this.filteredrows.length&&(this.filteredrows=this.collection.prepareFullDocIndex());var e=new v(this.collection);return e.filteredrows=this.filteredrows.slice(0,t),e.filterInitialized=!0,e},v.prototype.offset=function(t){this.searchIsChained&&!this.filterInitialized&&0===this.filteredrows.length&&(this.filteredrows=this.collection.prepareFullDocIndex());var e=new v(this.collection);return e.filteredrows=this.filteredrows.slice(t),e.filterInitialized=!0,e},v.prototype.copy=function(){var t=new v(this.collection);return this.filteredrows.length>0&&(t.filteredrows=this.filteredrows.slice()),t.filterInitialized=this.filterInitialized,t},v.prototype.branch=v.prototype.copy,v.prototype.transform=function(t,e){var i,n,r=this;if("string"==typeof t&&this.collection.transforms.hasOwnProperty(t)&&(t=this.collection.transforms[t]),"object"!=typeof t||!Array.isArray(t))throw new Error("Invalid transform");for("undefined"!=typeof e&&(t=S.resolveTransformParams(t,e)),i=0;i<t.length;i++)switch(n=t[i],n.type){case"find":r.find(n.value);break;case"where":r.where(n.value);break;case"simplesort":r.simplesort(n.property,n.desc);break;case"compoundsort":r.compoundsort(n.value);break;case"sort":r.sort(n.value);break;case"limit":r=r.limit(n.value);break;case"offset":r=r.offset(n.value);break;case"map":r=r.map(n.value);break;case"eqJoin":r=r.eqJoin(n.joinData,n.leftJoinKey,n.rightJoinKey,n.mapFun);break;case"mapReduce":r=r.mapReduce(n.mapFunction,n.reduceFunction);break;case"update":r.update(n.value);break;case"remove":r.remove()}return r},v.prototype.sort=function(t){this.searchIsChained&&!this.filterInitialized&&0===this.filteredrows.length&&(this.filteredrows=this.collection.prepareFullDocIndex());var e=function(t,e){return function(i,n){return t(e[i],e[n])}}(t,this.collection.data);return this.filteredrows.sort(e),this},v.prototype.simplesort=function(t,e){this.searchIsChained&&!this.filterInitialized&&0===this.filteredrows.length&&(this.filteredrows=this.collection.prepareFullDocIndex()),"undefined"==typeof e&&(e=!1);var i=function(t,e,i){return function(r,s){return n(i[r][t],i[s][t],e)}}(t,e,this.collection.data);return this.filteredrows.sort(i),this},v.prototype.compoundsort=function(t){if(0===t.length)throw new Error("Invalid call to compoundsort, need at least one property");var e;if(1===t.length)return e=t[0],Array.isArray(e)?this.simplesort(e[0],e[1]):this.simplesort(e,!1);for(var i=0,n=t.length;i<n;i+=1)e=t[i],Array.isArray(e)||(t[i]=[e,!1]);this.searchIsChained&&!this.filterInitialized&&0===this.filteredrows.length&&(this.filteredrows=this.collection.prepareFullDocIndex());var s=function(t,e){return function(i,n){return r(t,e[i],e[n])}}(t,this.collection.data);return this.filteredrows.sort(s),this},v.prototype.findOr=function(t){for(var e=null,i=0,n=0,r=[],s=[],o=0,a=this.count(),h=0,l=t.length;h<l;h++){if(e=this.branch().find(t[h]).filteredrows,n=e.length,n===a)return this;for(i=0;i<n;i++)o=e[i],void 0===s[o]&&(s[o]=!0,r.push(o))}return this.filteredrows=r,this.filterInitialized=!0,this},v.prototype.$or=v.prototype.findOr,v.prototype.findAnd=function(t){for(var e=0,i=t.length;e<i;e++){if(0===this.count())return this;this.find(t[e])}return this},v.prototype.$and=v.prototype.findAnd,v.prototype.find=function(t,e){if(0===this.collection.data.length)return this.searchIsChained?(this.filteredrows=[],this.filterInitialized=!0,this):[];var i,n,r,o,a,h,l=t||"getAll",u=!1,c=[],f=null;if(e=e||!1,"object"==typeof l)for(i in l)if(E.call(l,i)){n=i,r=l[i];break}if(!n||"getAll"===l)return e?this.collection.data.length>0?this.collection.data[0]:null:this.searchIsChained?this:this.collection.data.slice();if("$and"===n||"$or"===n)return this.searchIsChained?(this[n](r),e&&this.filteredrows.length>1&&(this.filteredrows=this.filteredrows.slice(0,1)),this):(c=this.collection.chain()[n](r).data(),e?0===c.length?[]:c[0]:c);if(null===r||"object"!=typeof r||r instanceof Date)o="$eq",a=r;else{if("object"!=typeof r)throw new Error("Do not know what you want to do.");for(h in r)if(E.call(r,h)){o=h,a=r[h];break}}"$regex"===o&&(Array.isArray(a)?a=new RegExp(a[0],a[1]):a instanceof RegExp||(a=new RegExp(a)));var p=n.indexOf(".")!==-1,d=!(p||this.searchIsChained&&this.filterInitialized);d&&this.collection.binaryIndices[n]&&M.indexOf(o)!==-1&&(this.collection.adaptiveBinaryIndices!==!0&&this.collection.ensureIndex(n),u=!0,f=this.collection.binaryIndices[n]);var y=F[o],v=this.collection.data,m=0;if(!this.searchIsChained){if(u){var g=this.collection.calculateRange(o,n,a);if(e)return g[1]!==-1?v[f.values[g[0]]]:[];for(m=g[0];m<=g[1];m++)c.push(v[f.values[m]])}else{if(m=v.length,e){if(p){for(n=n.split(".");m--;)if(s(v[m],n,y,a))return v[m]}else for(;m--;)if(y(v[m][n],a))return v[m];return[]}if(p)for(n=n.split(".");m--;)s(v[m],n,y,a)&&c.push(v[m]);else for(;m--;)y(v[m][n],a)&&c.push(v[m])}return c}var w,b=0;if(this.filterInitialized)if(w=this.filteredrows,m=w.length,p)for(n=n.split(".");m--;)b=w[m],s(v[b],n,y,a)&&c.push(b);else for(;m--;)b=w[m],y(v[b][n],a)&&c.push(b);else{if(u){var I=this.collection.calculateRange(o,n,a);for(m=I[0];m<=I[1];m++)c.push(f.values[m])}else if(m=v.length,p)for(n=n.split(".");m--;)s(v[m],n,y,a)&&c.push(m);else for(;m--;)y(v[m][n],a)&&c.push(m);this.filterInitialized=!0}return this.filteredrows=c,this},v.prototype.where=function(t){var e,i=[];if("function"!=typeof t)throw new TypeError("Argument is not a stored view or a function");e=t;try{if(this.searchIsChained){if(this.filterInitialized){for(var n=this.filteredrows.length;n--;)e(this.collection.data[this.filteredrows[n]])===!0&&i.push(this.filteredrows[n]);return this.filteredrows=i,this}for(var r=this.collection.data.length;r--;)e(this.collection.data[r])===!0&&i.push(r);return this.filteredrows=i,this.filterInitialized=!0,this}for(var s=this.collection.data.length;s--;)e(this.collection.data[s])===!0&&i.push(this.collection.data[s]);return i}catch(t){throw t}},v.prototype.count=function(){return this.searchIsChained&&this.filterInitialized?this.filteredrows.length:this.collection.count()},v.prototype.data=function(t){var e,i,n,r=[],s=this.collection.data;if(t=t||{},this.searchIsChained&&!this.filterInitialized){if(0===this.filteredrows.length){if(this.collection.cloneObjects||t.forceClones){for(e=s.length,n=t.forceCloneMethod||this.collection.cloneMethod,i=0;i<e;i++)r.push(l(s[i],n));return r}return s.slice()}this.filterInitialized=!0}var o=this.filteredrows;if(e=o.length,this.collection.cloneObjects||t.forceClones)for(n=t.forceCloneMethod||this.collection.cloneMethod,i=0;i<e;i++)r.push(l(s[o[i]],n));else for(i=0;i<e;i++)r.push(s[o[i]]);return r},v.prototype.update=function(t){if("function"!=typeof t)throw new TypeError("Argument is not a function");this.searchIsChained&&!this.filterInitialized&&0===this.filteredrows.length&&(this.filteredrows=this.collection.prepareFullDocIndex());for(var e=this.filteredrows.length,i=this.collection.data,n=0;n<e;n++)t(i[this.filteredrows[n]]),this.collection.update(i[this.filteredrows[n]]);return this},v.prototype.remove=function(){return this.searchIsChained&&!this.filterInitialized&&0===this.filteredrows.length&&(this.filteredrows=this.collection.prepareFullDocIndex()),this.collection.remove(this.data()),this.filteredrows=[],this},v.prototype.mapReduce=function(t,e){try{return e(this.data().map(t))}catch(t){throw t}},v.prototype.eqJoin=function(t,e,i,n){var r,s,o,a=[],h=[],l=[],u="function"==typeof e,c="function"==typeof i,f={};if(a=this.data(),r=a.length,t instanceof v)h=t.data();else{if(!Array.isArray(t))throw new TypeError("joinData needs to be an array or result set");h=t}s=h.length;for(var p=0;p<s;p++)o=c?i(h[p]):h[p][i],f[o]=h[p];n||(n=function(t,e){return{left:t,right:e}});for(var d=0;d<r;d++)o=u?e(a[d]):a[d][e],l.push(n(a[d],f[o]||{}));return this.collection=new g("joinData"),this.collection.insert(l),this.filteredrows=[],this.filterInitialized=!1,this},v.prototype.map=function(t){var e=this.data().map(t);return this.collection=new g("mappedData"),this.collection.insert(e),this.filteredrows=[],this.filterInitialized=!1,this},m.prototype=new f,m.prototype.rematerialize=function(t){var e,i,n;if(t=t||{},this.resultdata=[],this.resultsdirty=!0,this.resultset=new v(this.collection),(this.sortFunction||this.sortCriteria)&&(this.sortDirty=!0),t.hasOwnProperty("removeWhereFilters"))for(e=this.filterPipeline.length,i=e;i--;)"where"===this.filterPipeline[i].type&&(i!==this.filterPipeline.length-1&&(this.filterPipeline[i]=this.filterPipeline[this.filterPipeline.length-1]),this.filterPipeline.length--);var r=this.filterPipeline;for(this.filterPipeline=[],e=r.length,n=0;n<e;n++)this.applyFind(r[n].val);return this.data(),this.emit("rebuild",this),this},m.prototype.branchResultset=function(t,e){var i=this.resultset.branch();return"undefined"==typeof t?i:i.transform(t,e)},m.prototype.toJSON=function(){var t=new m(this.collection,this.name,this.options);return t.resultset=this.resultset,t.resultdata=[],t.resultsdirty=!0,t.filterPipeline=this.filterPipeline,t.sortFunction=this.sortFunction,t.sortCriteria=this.sortCriteria,t.sortDirty=this.sortDirty,t.collection=null,t},m.prototype.removeFilters=function(){this.rebuildPending=!1,this.resultset.reset(),this.resultdata=[],this.resultsdirty=!1,this.cachedresultset=null,this.filterPipeline=[],this.sortFunction=null,this.sortCriteria=null,this.sortDirty=!1},m.prototype.applySort=function(t){return this.sortFunction=t,this.sortCriteria=null,this.queueSortPhase(),this},m.prototype.applySimpleSort=function(t,e){return this.sortCriteria=[[t,e||!1]],this.sortFunction=null,this.queueSortPhase(),this},m.prototype.applySortCriteria=function(t){return this.sortCriteria=t,this.sortFunction=null,this.queueSortPhase(),this},m.prototype.startTransaction=function(){return this.cachedresultset=this.resultset.copy(),this},m.prototype.commit=function(){return this.cachedresultset=null,this},m.prototype.rollback=function(){return this.resultset=this.cachedresultset,this.options.persistent&&(this.resultdata=this.resultset.data(),this.emit("rebuild",this)),this},m.prototype._indexOfFilterWithId=function(t){if("string"==typeof t||"number"==typeof t)for(var e=0,i=this.filterPipeline.length;e<i;e+=1)if(t===this.filterPipeline[e].uid)return e;return-1},m.prototype._addFilter=function(t){this.filterPipeline.push(t),this.resultset[t.type](t.val)},m.prototype.reapplyFilters=function(){this.resultset.reset(),this.cachedresultset=null,this.options.persistent&&(this.resultdata=[],this.resultsdirty=!0);var t=this.filterPipeline;this.filterPipeline=[];for(var e=0,i=t.length;e<i;e+=1)this._addFilter(t[e]);return this.sortFunction||this.sortCriteria?this.queueSortPhase():this.queueRebuildEvent(),this},m.prototype.applyFilter=function(t){var e=this._indexOfFilterWithId(t.uid);return e>=0?(this.filterPipeline[e]=t,this.reapplyFilters()):(this.cachedresultset=null,this.options.persistent&&(this.resultdata=[],this.resultsdirty=!0),this._addFilter(t),this.sortFunction||this.sortCriteria?this.queueSortPhase():this.queueRebuildEvent(),this)},m.prototype.applyFind=function(t,e){return this.applyFilter({type:"find",val:t,uid:e}),this},m.prototype.applyWhere=function(t,e){return this.applyFilter({type:"where",val:t,uid:e}),this},m.prototype.removeFilter=function(t){var e=this._indexOfFilterWithId(t);if(e<0)throw new Error("Dynamic view does not contain a filter with ID: "+t);return this.filterPipeline.splice(e,1),this.reapplyFilters(),this},m.prototype.count=function(){return this.options.persistent?this.resultdata.length:this.resultset.count()},m.prototype.data=function(){return(this.sortDirty||this.resultsdirty)&&this.performSortPhase({suppressRebuildEvent:!0}),this.options.persistent?this.resultdata:this.resultset.data()},m.prototype.queueRebuildEvent=function(){if(!this.rebuildPending){this.rebuildPending=!0;var t=this;setTimeout(function(){t.rebuildPending&&(t.rebuildPending=!1,t.emit("rebuild",t))},this.options.minRebuildInterval)}},m.prototype.queueSortPhase=function(){if(!this.sortDirty){this.sortDirty=!0;var t=this;"active"===this.options.sortPriority?setTimeout(function(){t.performSortPhase()},this.options.minRebuildInterval):this.queueRebuildEvent()}},m.prototype.performSortPhase=function(t){(this.sortDirty||this.resultsdirty)&&(t=t||{},this.sortDirty&&(this.sortFunction?this.resultset.sort(this.sortFunction):this.sortCriteria&&this.resultset.compoundsort(this.sortCriteria),this.sortDirty=!1),this.options.persistent&&(this.resultdata=this.resultset.data(),this.resultsdirty=!1),t.suppressRebuildEvent||this.emit("rebuild",this))},m.prototype.evaluateDocument=function(t,e){if(!this.resultset.filterInitialized)return this.options.persistent&&(this.resultdata=this.resultset.data()),void(this.sortFunction||this.sortCriteria?this.queueSortPhase():this.queueRebuildEvent());var i=this.resultset.filteredrows,n=e?-1:i.indexOf(+t),r=i.length,s=new v(this.collection);s.filteredrows=[t],s.filterInitialized=!0;for(var o,a=0,h=this.filterPipeline.length;a<h;a++)o=this.filterPipeline[a],s[o.type](o.val);var l=0===s.filteredrows.length?-1:0;return n!==-1||l!==-1?n===-1&&l!==-1?(i.push(t),this.options.persistent&&this.resultdata.push(this.collection.data[t]),void(this.sortFunction||this.sortCriteria?this.queueSortPhase():this.queueRebuildEvent())):n!==-1&&l===-1?(n<r-1?(i.splice(n,1),this.options.persistent&&this.resultdata.splice(n,1)):(i.length=r-1,this.options.persistent&&(this.resultdata.length=r-1)),void(this.sortFunction||this.sortCriteria?this.queueSortPhase():this.queueRebuildEvent())):n!==-1&&l!==-1?(this.options.persistent&&(this.resultdata[n]=this.collection.data[t]),void(this.sortFunction||this.sortCriteria?this.queueSortPhase():this.queueRebuildEvent())):void 0:void 0;
},m.prototype.removeDocument=function(t){if(!this.resultset.filterInitialized)return this.options.persistent&&(this.resultdata=this.resultset.data()),void(this.sortFunction||this.sortCriteria?this.queueSortPhase():this.queueRebuildEvent());var e,i=this.resultset.filteredrows,n=i.indexOf(+t),r=i.length;for(n!==-1&&(n<r-1?(i[n]=i[r-1],i.length=r-1,this.options.persistent&&(this.resultdata[n]=this.resultdata[r-1],this.resultdata.length=r-1)):(i.length=r-1,this.options.persistent&&(this.resultdata.length=r-1)),this.sortFunction||this.sortCriteria?this.queueSortPhase():this.queueRebuildEvent()),r=i.length,e=0;e<r;e++)i[e]>t&&i[e]--},m.prototype.mapReduce=function(t,e){try{return e(this.data().map(t))}catch(t){throw t}},g.prototype=new f,g.prototype.console={log:function(){},warn:function(){},error:function(){}},g.prototype.addAutoUpdateObserver=function(t){this.autoupdate&&"function"==typeof Object.observe&&Object.observe(t,this.observerCallback,["add","update","delete","reconfigure","setPrototype"])},g.prototype.removeAutoUpdateObserver=function(t){this.autoupdate&&"function"==typeof Object.observe&&Object.unobserve(t,this.observerCallback)},g.prototype.addTransform=function(t,e){if(this.transforms.hasOwnProperty(t))throw new Error("a transform by that name already exists");this.transforms[t]=e},g.prototype.setTransform=function(t,e){this.transforms[t]=e},g.prototype.removeTransform=function(t){delete this.transforms[t]},g.prototype.byExample=function(t){var e,i,n;n=[];for(e in t)t.hasOwnProperty(e)&&n.push((i={},i[e]=t[e],i));return{$and:n}},g.prototype.findObject=function(t){return this.findOne(this.byExample(t))},g.prototype.findObjects=function(t){return this.find(this.byExample(t))},g.prototype.ttlDaemonFuncGen=function(){var t=this,e=this.ttl.age;return function(){var i=Date.now(),n=t.chain().where(function(t){var n=t.meta.updated||t.meta.created,r=i-n;return e<r});n.remove()}},g.prototype.setTTL=function(t,e){t<0?clearInterval(this.ttl.daemon):(this.ttl.age=t,this.ttl.ttlInterval=e,this.ttl.daemon=setInterval(this.ttlDaemonFuncGen(),e))},g.prototype.prepareFullDocIndex=function(){for(var t=this.data.length,e=new Array(t),i=0;i<t;i+=1)e[i]=i;return e},g.prototype.configureOptions=function(t){t=t||{},t.hasOwnProperty("adaptiveBinaryIndices")&&(this.adaptiveBinaryIndices=t.adaptiveBinaryIndices,this.adaptiveBinaryIndices&&this.ensureAllIndexes())},g.prototype.ensureIndex=function(i,n){if("undefined"==typeof n&&(n=!1),null===i||void 0===i)throw new Error("Attempting to set index without an associated property");if(!this.binaryIndices[i]||n||this.binaryIndices[i].dirty){var r={name:i,dirty:!0,values:this.prepareFullDocIndex()};this.binaryIndices[i]=r;var s=function(i,n){return function(r,s){var o=n[r][i],a=n[s][i];if(o!==a){if(t(o,a,!1))return-1;if(e(o,a,!1))return 1}return 0}}(i,this.data);r.values.sort(s),r.dirty=!1,this.dirty=!0}},g.prototype.getSequencedIndexValues=function(t){var e,i=this.binaryIndices[t].values,n="";for(e=0;e<i.length;e++)n+=" ["+e+"] "+this.data[i[e]][t];return n},g.prototype.ensureUniqueIndex=function(t){var e=this.constraints.unique[t];return e||this.uniqueNames.indexOf(t)==-1&&this.uniqueNames.push(t),this.constraints.unique[t]=e=new j(t),this.data.forEach(function(t){e.set(t)}),e},g.prototype.ensureAllIndexes=function(t){var e,i=this.binaryIndices;for(e in i)E.call(i,e)&&this.ensureIndex(e,t)},g.prototype.flagBinaryIndexesDirty=function(){var t,e=this.binaryIndices;for(t in e)E.call(e,t)&&(e[t].dirty=!0)},g.prototype.flagBinaryIndexDirty=function(t){this.binaryIndices[t]&&(this.binaryIndices[t].dirty=!0)},g.prototype.count=function(t){return t?this.chain().find(t).filteredrows.length:this.data.length},g.prototype.ensureId=function(){var t=this.data.length,e=0;for(this.idIndex=[],e;e<t;e+=1)this.idIndex.push(this.data[e].$loki)},g.prototype.addDynamicView=function(t,e){var i=new m(this,t,e);return this.DynamicViews.push(i),i},g.prototype.removeDynamicView=function(t){for(var e=0;e<this.DynamicViews.length;e++)this.DynamicViews[e].name===t&&this.DynamicViews.splice(e,1)},g.prototype.getDynamicView=function(t){for(var e=0;e<this.DynamicViews.length;e++)if(this.DynamicViews[e].name===t)return this.DynamicViews[e];return null},g.prototype.findAndUpdate=function(t,e){var i,n=this.where(t),r=0;try{for(r;r<n.length;r++)i=e(n[r]),this.update(i)}catch(t){this.rollback(),this.console.error(t.message)}},g.prototype.insert=function(t){if(!Array.isArray(t))return this.insertOne(t);var e,i=[];this.emit("pre-insert",t);for(var n=0,r=t.length;n<r;n++){if(e=this.insertOne(t[n],!0),!e)return;i.push(e)}return this.emit("insert",t),1===i.length?i[0]:i},g.prototype.insertOne=function(t,e){var i,n=null;if("object"!=typeof t?n=new TypeError("Document needs to be an object"):null===t&&(n=new TypeError("Object cannot be null")),null!==n)throw this.emit("error",n),n;var r=this.cloneObjects?l(t,this.cloneMethod):t;if("undefined"==typeof r.meta&&(r.meta={revision:0,created:0}),i=this.cloneObjects?l(r,this.cloneMethod):r,e||this.emit("pre-insert",r),this.add(r))return this.addAutoUpdateObserver(i),e||this.emit("insert",i),i},g.prototype.clear=function(){this.data=[],this.idIndex=[],this.binaryIndices={},this.cachedIndex=null,this.cachedBinaryIndex=null,this.cachedData=null,this.maxId=0,this.DynamicViews=[],this.dirty=!0},g.prototype.update=function(t){if(Array.isArray(t)){var e=0,i=t.length;for(e;e<i;e+=1)this.update(t[e])}else{if(!E.call(t,"$loki"))throw new Error("Trying to update unsynced document. Please save the document first by using insert() or addMany()");try{this.startTransaction();var n,r,s,o=this.get(t.$loki,!0),a=this;if(n=o[0],s=o[1],r=this.cloneObjects?l(t,this.cloneMethod):t,!o)throw new Error("Trying to update a document not in collection.");this.emit("pre-update",t),Object.keys(this.constraints.unique).forEach(function(t){a.constraints.unique[t].update(n,r)}),this.data[s]=r,r!==t&&this.addAutoUpdateObserver(t);for(var h=0;h<this.DynamicViews.length;h++)this.DynamicViews[h].evaluateDocument(s,!1);var u;if(this.adaptiveBinaryIndices){var c=this.binaryIndices;for(u in c)this.adaptiveBinaryIndexUpdate(s,u)}else this.flagBinaryIndexesDirty();return this.idIndex[s]=r.$loki,this.commit(),this.dirty=!0,this.emit("update",t,this.cloneObjects?l(n,this.cloneMethod):null),t}catch(t){throw this.rollback(),this.console.error(t.message),this.emit("error",t),t}}},g.prototype.add=function(t){if("object"!=typeof t)throw new TypeError("Object being added needs to be an object");if("undefined"!=typeof t.$loki)throw new Error("Document is already in collection, please use update()");try{this.startTransaction(),this.maxId++,isNaN(this.maxId)&&(this.maxId=this.data[this.data.length-1].$loki+1),t.$loki=this.maxId,t.meta.version=0;var e,i=this.constraints.unique;for(e in i)E.call(i,e)&&i[e].set(t);this.idIndex.push(t.$loki),this.data.push(t);for(var n=this.data.length-1,r=this.DynamicViews.length,s=0;s<r;s++)this.DynamicViews[s].evaluateDocument(n,!0);if(this.adaptiveBinaryIndices){var o=this.binaryIndices;for(e in o)this.adaptiveBinaryIndexInsert(n,e)}else this.flagBinaryIndexesDirty();return this.commit(),this.dirty=!0,this.cloneObjects?l(t,this.cloneMethod):t}catch(t){throw this.rollback(),this.console.error(t.message),this.emit("error",t),t}},g.prototype.removeWhere=function(t){var e;e="function"==typeof t?this.data.filter(t):new v(this,{queryObj:t}),this.remove(e)},g.prototype.removeDataOnly=function(){this.remove(this.data.slice())},g.prototype.remove=function(t){if("number"==typeof t&&(t=this.get(t)),"object"!=typeof t)throw new Error("Parameter is not an object");if(Array.isArray(t)){var e=0,i=t.length;for(e;e<i;e+=1)this.remove(t[e])}else{if(!E.call(t,"$loki"))throw new Error("Object is not a document stored in the collection");try{this.startTransaction();var n=this.get(t.$loki,!0),r=n[1],s=this;Object.keys(this.constraints.unique).forEach(function(e){null!==t[e]&&"undefined"!=typeof t[e]&&s.constraints.unique[e].remove(t[e])});for(var o=0;o<this.DynamicViews.length;o++)this.DynamicViews[o].removeDocument(r);if(this.adaptiveBinaryIndices){var a,h=this.binaryIndices;for(a in h)this.adaptiveBinaryIndexRemove(r,a)}else this.flagBinaryIndexesDirty();return this.data.splice(r,1),this.removeAutoUpdateObserver(t),this.idIndex.splice(r,1),this.commit(),this.dirty=!0,this.emit("delete",n[0]),delete t.$loki,delete t.meta,t}catch(t){return this.rollback(),this.console.error(t.message),this.emit("error",t),null}}},g.prototype.get=function(t,e){var i=e||!1,n=this.idIndex,r=n.length-1,s=0,o=s+r>>1;if(t="number"==typeof t?t:parseInt(t,10),isNaN(t))throw new TypeError("Passed id is not an integer");for(;n[s]<n[r];)o=s+r>>1,n[o]<t?s=o+1:r=o;return r===s&&n[s]===t?i?[this.data[s],s]:this.data[s]:null},g.prototype.getBinaryIndexPosition=function(t,e){var i=this.data[t][e],n=this.binaryIndices[e].values,r=this.calculateRange("$eq",e,i);if(0===r[0]&&r[1]===-1)return null;for(var s=r[0],o=r[1],a=s;a<=o;a++)if(n[a]===t)return a;return null},g.prototype.adaptiveBinaryIndexInsert=function(t,e){var i=(this.binaryIndices[e].values,this.data[t][e]),n=this.calculateRangeStart(e,i);this.binaryIndices[e].values.splice(n,0,t)},g.prototype.adaptiveBinaryIndexUpdate=function(t,e){var i,n=this.binaryIndices[e].values,r=n.length;for(i=0;i<r&&n[i]!==t;i++);this.binaryIndices[e].values.splice(i,1),this.adaptiveBinaryIndexInsert(t,e)},g.prototype.adaptiveBinaryIndexRemove=function(t,e,i){var n,r,s=this.getBinaryIndexPosition(t,e),o=this.binaryIndices[e].values;if(null===s)return null;if(this.binaryIndices[e].values.splice(s,1),i!==!0)for(n=o.length,r=0;r<n;r++)o[r]>t&&o[r]--},g.prototype.calculateRangeStart=function(e,i){var n=this.data,r=this.binaryIndices[e].values,s=0,o=r.length-1,a=0;if(0===r.length)return 0;for(n[r[s]][e],n[r[o]][e];s<o;)a=s+o>>1,t(n[r[a]][e],i,!1)?s=a+1:o=a;var h=s;return t(n[r[h]][e],i,!1)?h+1:h},g.prototype.calculateRange=function(i,n,r){var s=this.data,o=this.binaryIndices[n].values,a=0,h=o.length-1,l=0;if(0===s.length)return[0,-1];var u=s[o[a]][n],c=s[o[h]][n];switch(i){case"$eq":case"$aeq":if(t(r,u,!1)||e(r,c,!1))return[0,-1];break;case"$dteq":if(t(r,u,!1)||e(r,c,!1))return[0,-1];break;case"$gt":if(e(r,c,!0))return[0,-1];break;case"$gte":if(e(r,c,!1))return[0,-1];break;case"$lt":if(t(r,u,!0))return[0,-1];if(t(c,r,!1))return[0,s.length-1];break;case"$lte":if(t(r,u,!1))return[0,-1];if(t(c,r,!0))return[0,s.length-1]}for(;a<h;)l=a+h>>1,t(s[o[l]][n],r,!1)?a=l+1:h=l;var f=a;for(h=o.length-1;a<h;)l=a+h>>1,t(r,s[o[l]][n],!1)?h=l:a=l+1;var p=h,d=s[o[f]][n],y=s[o[p]][n];switch(i){case"$eq":return d!==r?[0,-1]:(y!==r&&p--,[f,p]);case"$dteq":return d>r||d<r?[0,-1]:((y>r||y<r)&&p--,[f,p]);case"$gt":return t(y,r,!0)?[0,-1]:[p,s.length-1];case"$gte":return t(d,r,!1)?[0,-1]:[f,s.length-1];case"$lt":return 0===f&&t(d,r,!1)?[0,0]:[0,f-1];case"$lte":return y!==r&&p--,0===p&&t(y,r,!1)?[0,0]:[0,p];default:return[0,s.length-1]}},g.prototype.by=function(t,e){var i;if(void 0===e)return i=this,function(e){return i.by(t,e)};var n=this.constraints.unique[t].get(e);return this.cloneObjects?l(n,this.cloneMethod):n},g.prototype.findOne=function(t){t=t||{};var e=new v(this,{queryObj:t,firstOnly:!0});return Array.isArray(e)&&0===e.length?null:this.cloneObjects?l(e,this.cloneMethod):e},g.prototype.chain=function(t,e){var i=new v(this);return"undefined"==typeof t?i:i.transform(t,e)},g.prototype.find=function(t){"undefined"==typeof t&&(t="getAll");var e=new v(this,{queryObj:t});return this.cloneObjects?u(e,this.cloneMethod):e},g.prototype.findOneUnindexed=function(t,e){for(var i,n=this.data.length;n--;)if(this.data[n][t]===e)return i=this.data[n];return null},g.prototype.startTransaction=function(){if(this.transactional){this.cachedData=l(this.data,this.cloneMethod),this.cachedIndex=this.idIndex,this.cachedBinaryIndex=this.binaryIndices;for(var t=0;t<this.DynamicViews.length;t++)this.DynamicViews[t].startTransaction()}},g.prototype.commit=function(){if(this.transactional){this.cachedData=null,this.cachedIndex=null,this.cachedBinaryIndex=null;for(var t=0;t<this.DynamicViews.length;t++)this.DynamicViews[t].commit()}},g.prototype.rollback=function(){if(this.transactional){null!==this.cachedData&&null!==this.cachedIndex&&(this.data=this.cachedData,this.idIndex=this.cachedIndex,this.binaryIndices=this.cachedBinaryIndex);for(var t=0;t<this.DynamicViews.length;t++)this.DynamicViews[t].rollback()}},g.prototype.where=function(t){var e=new v(this,{queryFunc:t});return this.cloneObjects?u(e,this.cloneMethod):e},g.prototype.mapReduce=function(t,e){try{return e(this.data.map(t))}catch(t){throw t}},g.prototype.eqJoin=function(t,e,i,n){return new v(this).eqJoin(t,e,i,n)},g.prototype.stages={},g.prototype.getStage=function(t){return this.stages[t]||(this.stages[t]={}),this.stages[t]},g.prototype.commitLog=[],g.prototype.stage=function(t,e){var i=JSON.parse(JSON.stringify(e));return this.getStage(t)[e.$loki]=i,i},g.prototype.commitStage=function(t,e){var i,n=this.getStage(t),r=(new Date).getTime();for(i in n)this.update(n[i]),this.commitLog.push({timestamp:r,message:e,data:JSON.parse(JSON.stringify(n[i]))});this.stages[t]={}},g.prototype.no_op=function(){},g.prototype.extract=function(t){var e=0,i=this.data.length,n=w(t),r=[];for(e;e<i;e+=1)r.push(P(this.data[e],t,n));return r},g.prototype.max=function(t){return Math.max.apply(null,this.extract(t))},g.prototype.min=function(t){return Math.min.apply(null,this.extract(t))},g.prototype.maxRecord=function(t){var e,i=0,n=this.data.length,r=w(t),s={index:0,value:void 0};for(i;i<n;i+=1)void 0!==e?e<P(this.data[i],t,r)&&(e=P(this.data[i],t,r),s.index=this.data[i].$loki):(e=P(this.data[i],t,r),s.index=this.data[i].$loki);return s.value=e,s},g.prototype.minRecord=function(t){var e,i=0,n=this.data.length,r=w(t),s={index:0,value:void 0};for(i;i<n;i+=1)void 0!==e?e>P(this.data[i],t,r)&&(e=P(this.data[i],t,r),s.index=this.data[i].$loki):(e=P(this.data[i],t,r),s.index=this.data[i].$loki);return s.value=e,s},g.prototype.extractNumerical=function(t){return this.extract(t).map(b).filter(Number).filter(function(t){return!isNaN(t)})},g.prototype.avg=function(t){return O(this.extractNumerical(t))},g.prototype.stdDev=function(t){return D(this.extractNumerical(t))},g.prototype.mode=function(t){var e={},i=this.extract(t);i.forEach(function(t){e[t]?e[t]+=1:e[t]=1});var n,r,s;for(r in e)n?n<e[r]&&(s=r):(s=r,n=e[r]);return s},g.prototype.median=function(t){var e=this.extractNumerical(t);e.sort(x);var i=Math.floor(e.length/2);return e.length%2?e[i]:(e[i-1]+e[i])/2},q.prototype={keys:[],values:[],sort:function(t,e){return t<e?-1:t>e?1:0},setSort:function(t){this.bs=new A(t)},bs:function(){return new A(this.sort)},set:function(t,e){var i=this.bs(this.keys,t);i.found?this.values[i.index]=e:(this.keys.splice(i.index,0,t),this.values.splice(i.index,0,e))},get:function(t){return this.values[k(this.keys,t,this.sort).index]}},j.prototype.keyMap={},j.prototype.lokiMap={},j.prototype.set=function(t){var e=t[this.field];if(null!==e&&"undefined"!=typeof e){if(this.keyMap[e])throw new Error("Duplicate key for property "+this.field+": "+e);this.keyMap[e]=t,this.lokiMap[t.$loki]=e}},j.prototype.get=function(t){return this.keyMap[t]},j.prototype.byId=function(t){return this.keyMap[this.lokiMap[t]]},j.prototype.update=function(t,e){if(this.lokiMap[t.$loki]!==e[this.field]){var i=this.lokiMap[t.$loki];this.set(e),this.keyMap[i]=void 0}else this.keyMap[t[this.field]]=e},j.prototype.remove=function(t){var e=this.keyMap[t];if(null===e||"undefined"==typeof e)throw new Error("Key is not in unique index: "+this.field);this.keyMap[t]=void 0,this.lokiMap[e.$loki]=void 0},j.prototype.clear=function(){this.keyMap={},this.lokiMap={}},C.prototype={set:function(t,e){this.index[t]?this.index[t].push(e):this.index[t]=[e]},remove:function(t,e){var i=this.index[t];for(var n in i)i[n]==e&&i.splice(n,1);i.length<1&&(this.index[t]=void 0)},get:function(t){return this.index[t]},clear:function(t){this.index={}}},$.prototype={keys:[],values:[],sort:function(t,e){return t<e?-1:t>e?1:0},bs:function(){return new A(this.sort)},setSort:function(t){this.bs=new A(t)},set:function(t,e){var i=k(this.keys,t,this.sort);i.found?this.values[i.index].push(e):(this.keys.splice(i.index,0,t),this.values.splice(i.index,0,[e]))},get:function(t){var e=k(this.keys,t,this.sort);return e.found?this.values[e.index]:[]},getLt:function(t){var e=k(this.keys,t,this.sort),i=e.index;return e.found&&i--,this.getAll(t,0,i)},getGt:function(t){var e=k(this.keys,t,this.sort),i=e.index;return e.found&&i++,this.getAll(t,i,this.keys.length)},getAll:function(t,e,i){for(var n=[],r=e;r<i;r++)n=n.concat(this.values[r]);return n},getPos:function(t){return k(this.keys,t,this.sort)},remove:function(t,e){var i=k(this.keys,t,this.sort).index,n=this.values[i];for(var r in n)n[r]==e&&n.splice(r,1);n.length<1&&(this.keys.splice(i,1),this.values.splice(i,1))},clear:function(){this.keys=[],this.values=[]}},p.LokiOps=F,p.Collection=g,p.KeyValueStore=q,p.persistenceAdapters={fs:d,localStorage:y},p}()})}).call(e,function(){return this}())},14:function(e,i){e.exports=t}})});
//# sourceMappingURL=lokijs.loki.min.js.map