!function(t,e){"object"==typeof exports&&"object"==typeof module?module.exports=e():"function"==typeof define&&define.amd?define("core",[],e):"object"==typeof exports?exports.core=e():(t.lokijs=t.lokijs||{},t.lokijs.core=e())}(this,function(){return function(t){function e(n){if(i[n])return i[n].exports;var r=i[n]={exports:{},id:n,loaded:!1};return t[n].call(r.exports,r,r.exports,e),r.loaded=!0,r.exports}var i={};return e.m=t,e.c=i,e.p="",e(0)}([function(t,e,i){"use strict";var n=i(1);t.exports=n.Loki},function(t,e,i){(function(t){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.Loki=void 0;var n=i(2),r=i(3),s=i(4),o=i(5),a=i(10);class l extends n.LokiEventEmitter{constructor(e,i){super(),this.filename=e||"loki.db",this.collections=[],this.databaseVersion=1.1,this.engineVersion=1.1,this.autosave=!1,this.autosaveInterval=5e3,this.autosaveHandle=null,this.options={serializationMethod:i&&i.hasOwnProperty("serializationMethod")?i.serializationMethod:"normal",destructureDelimiter:i&&i.hasOwnProperty("destructureDelimiter")?i.destructureDelimiter:"$<\n"},this.persistenceMethod=null,this.persistenceAdapter=null,this.verbose=!(!i||!i.hasOwnProperty("verbose"))&&i.verbose,this.events={init:[],loaded:[],flushChanges:[],close:[],changes:[],warning:[]};var n=function(){return"undefined"==typeof window?"NODEJS":"undefined"!=typeof t&&t.window?"NODEJS":"undefined"!=typeof document?document.URL.indexOf("http://")===-1&&document.URL.indexOf("https://")===-1?"CORDOVA":"BROWSER":"CORDOVA"};i&&i.hasOwnProperty("env")?this.ENV=i.env:this.ENV=n(),this.on("init",this.clearChanges)}getIndexedAdapter(){var t;return t=i(13)}initializePersistence(t){var e=this,i={NODEJS:"fs",BROWSER:"localStorage",CORDOVA:"localStorage"},n={fs:r.LokiFsAdapter,localStorage:s.LokiLocalStorageAdapter};this.options=t||{},this.persistenceMethod=null,this.persistenceAdapter=null,this.options.hasOwnProperty("persistenceMethod")&&"function"==typeof n[this.options.persistenceMethod]&&(this.persistenceMethod=this.options.persistenceMethod,this.persistenceAdapter=new n[this.options.persistenceMethod]),this.options.hasOwnProperty("serializationMethod")||(this.options.serializationMethod="normal"),this.options.hasOwnProperty("destructureDelimiter")||(this.options.destructureDelimiter="$<\n"),null===this.persistenceAdapter&&(this.persistenceMethod=i[this.ENV],this.persistenceMethod&&(this.persistenceAdapter=new n[this.persistenceMethod])),this.options.hasOwnProperty("adapter")&&(this.persistenceMethod="adapter",this.persistenceAdapter=this.options.adapter),this.options.hasOwnProperty("autosaveInterval")&&(this.autosaveInterval=parseInt(this.options.autosaveInterval,10)),this.autosaveDisable();var o;return o=this.options.autoload?this.loadDatabase(this.options.inflate):Promise.resolve(),o.then(function(){e.options.autosave&&e.autosaveEnable()})}copy(t){var e,i,n=new l(this.filename);if(t=t||{},n.loadJSONObject(this,{retainDirtyFlags:!0}),t.hasOwnProperty("removeNonSerializable")&&t.removeNonSerializable===!0)for(n.autosaveHandle=null,n.persistenceAdapter=null,e=n.collections.length,i=0;i<e;i++)n.collections[i].constraints=null,n.collections[i].ttl=null;return n}anonym(t,e){var i=new o.Collection("anonym",e);return i.insert(t),this.verbose&&(i.console=console),i}addCollection(t,e){var i=new o.Collection(t,e);return this.collections.push(i),this.verbose&&(i.console=console),i}loadCollection(t){if(!t.name)throw new Error("Collection must have a name property to be loaded");this.collections.push(t)}getCollection(t){var e,i=this.collections.length;for(e=0;e<i;e+=1)if(this.collections[e].name===t)return this.collections[e];return this.emit("warning","collection "+t+" not found"),null}listCollections(){for(var t=this.collections.length,e=[];t--;)e.push({name:this.collections[t].name,type:this.collections[t].objType,count:this.collections[t].data.length});return e}removeCollection(t){var e,i=this.collections.length;for(e=0;e<i;e+=1)if(this.collections[e].name===t){var n=new o.Collection(t,{}),r=this.collections[e];for(var s in r)r.hasOwnProperty(s)&&n.hasOwnProperty(s)&&(r[s]=n[s]);return void this.collections.splice(e,1)}}getName(){return this.name}serializeReplacer(t,e){switch(t){case"autosaveHandle":case"persistenceAdapter":case"constraints":case"ttl":return null;default:return e}}serialize(t){switch(t=t||{},t.hasOwnProperty("serializationMethod")||(t.serializationMethod=this.options.serializationMethod),t.serializationMethod){case"normal":return JSON.stringify(this,this.serializeReplacer);case"pretty":return JSON.stringify(this,this.serializeReplacer,2);case"destructured":return this.serializeDestructured();default:return JSON.stringify(this,this.serializeReplacer)}}toJson(){return this.serialize}serializeDestructured(t){var e,i,n,r,s,o=[];if(t=t||{},t.hasOwnProperty("partitioned")||(t.partitioned=!1),t.hasOwnProperty("delimited")||(t.delimited=!0),t.hasOwnProperty("delimiter")||(t.delimiter=this.options.destructureDelimiter),t.partitioned===!0&&t.hasOwnProperty("partition")&&t.partition>=0)return this.serializeCollection({delimited:t.delimited,delimiter:t.delimiter,collectionIndex:t.partition});for(s=new l(this.filename),s.loadJSONObject(this),e=0;e<s.collections.length;e++)s.collections[e].data=[];if(t.partitioned===!0&&t.partition===-1)return s.serialize({serializationMethod:"normal"});for(o.push(s.serialize({serializationMethod:"normal"})),s=null,e=0;e<this.collections.length;e++)if(n=this.serializeCollection({delimited:t.delimited,delimiter:t.delimiter,collectionIndex:e}),t.partitioned===!1&&t.delimited===!1){if(!Array.isArray(n))throw new Error("a nondelimited, non partitioned collection serialization did not return an expected array");for(r=n.length,i=0;i<r;i++)o.push(n[i]),n[i]=null;o.push("")}else o.push(n);return t.partitioned?t.delimited?o:o:t.delimited?(o.push(""),o.join(t.delimiter)):(o.push(""),o)}serializeCollection(t){var e,i,n=[];if(t=t||{},t.hasOwnProperty("delimited")||(t.delimited=!0),!t.hasOwnProperty("collectionIndex"))throw new Error("serializeCollection called without 'collectionIndex' option");for(e=this.collections[t.collectionIndex].data.length,n=[],i=0;i<e;i++)n.push(JSON.stringify(this.collections[t.collectionIndex].data[i]));return t.delimited?(n.push(""),n.join(t.delimiter)):n}deserializeDestructured(t,e){var i,n,r,s,o,a=[],l=0,u=1,h=!1;if(e=e||{},e.hasOwnProperty("partitioned")||(e.partitioned=!1),e.hasOwnProperty("delimited")||(e.delimited=!0),e.hasOwnProperty("delimiter")||(e.delimiter=this.options.destructureDelimiter),e.partitioned){if(e.hasOwnProperty("partition"))return e.partition===-1?n=JSON.parse(t[0]):this.deserializeCollection(t[e.partition+1],e);for(n=JSON.parse(t[0]),r=n.collections.length,l=0;l<r;l++)n.collections[l].data=this.deserializeCollection(t[l+1],e);return n}if(e.delimited){if(a=t.split(e.delimiter),t=null,i=a.length,0===i)return null}else a=t;for(n=JSON.parse(a[0]),r=n.collections.length,a[0]=null;!h;)s=a[u],""===a[u]?++l>r&&(h=!0):(o=JSON.parse(a[u]),n.collections[l].data.push(o)),a[u++]=null;return n}deserializeCollection(t,e){var i,n,r=[];for(e=e||{},e.hasOwnProperty("partitioned")||(e.partitioned=!1),e.hasOwnProperty("delimited")||(e.delimited=!0),e.hasOwnProperty("delimiter")||(e.delimiter=this.options.destructureDelimiter),e.delimited?(r=t.split(e.delimiter),r.pop()):r=t,n=r.length,i=0;i<n;i++)r[i]=JSON.parse(r[i]);return r}loadJSON(t,e){var i;if(0===t.length)i={};else switch(this.options.serializationMethod){case"normal":case"pretty":i=JSON.parse(t);break;case"destructured":i=this.deserializeDestructured(t);break;default:i=JSON.parse(t)}this.loadJSONObject(i,e)}loadJSONObject(t,e){function i(t){var i,n=e[t.name];return n.proto?(i=n.inflate||a.Utils.copyProperties,function(t){var e=new n.proto;return i(t,e),e}):n.inflate}var n,r,s,o,l,u,h=0,c=t.collections?t.collections.length:0;for(this.name=t.name,this.databaseVersion=1,t.hasOwnProperty("databaseVersion")&&(this.databaseVersion=t.databaseVersion),this.collections=[],h;h<c;h+=1){if(n=t.collections[h],r=this.addCollection(n.name),r.adaptiveBinaryIndices=!!n.hasOwnProperty("adaptiveBinaryIndices")&&n.adaptiveBinaryIndices===!0,r.transactional=n.transactional,r.asyncListeners=n.asyncListeners,r.disableChangesApi=n.disableChangesApi,r.cloneObjects=n.cloneObjects,r.cloneMethod=n.cloneMethod||"parse-stringify",r.autoupdate=n.autoupdate,r.changes=n.changes,e&&e.retainDirtyFlags===!0?r.dirty=n.dirty:r.dirty=!1,s=n.data.length,o=0,e&&e.hasOwnProperty(n.name))for(l=i(n),o;o<s;o++)u=l(n.data[o]),r.data[o]=u,r.addAutoUpdateObserver(u);else for(o;o<s;o++)r.data[o]=n.data[o],r.addAutoUpdateObserver(r.data[o]);if(r.maxId=0===n.data.length?0:n.maxId,r.idIndex=n.idIndex,"undefined"!=typeof n.binaryIndices&&(r.binaryIndices=n.binaryIndices),"undefined"!=typeof n.transforms&&(r.transforms=n.transforms),r.ensureId(),r.uniqueNames=[],n.hasOwnProperty("uniqueNames"))for(r.uniqueNames=n.uniqueNames,o=0;o<r.uniqueNames.length;o++)r.ensureUniqueIndex(r.uniqueNames[o]);if("undefined"!=typeof n.DynamicViews)for(var f=0;f<n.DynamicViews.length;f++){var d=n.DynamicViews[f],p=r.addDynamicView(d.name,d.options);p.resultdata=d.resultdata,p.resultsdirty=d.resultsdirty,p.filterPipeline=d.filterPipeline,p.sortCriteria=d.sortCriteria,p.sortFunction=null,p.sortDirty=d.sortDirty,p.resultset.filteredrows=d.resultset.filteredrows,p.resultset.searchIsChained=d.resultset.searchIsChained,p.resultset.filterInitialized=d.resultset.filterInitialized,p.rematerialize({removeWhereFilters:!0})}}}close(){var t,e=this;return this.autosave&&(this.autosaveDisable(),this.autosaveDirty()&&(t=this.saveDatabase())),Promise.resolve(t).then(function(){e.emit("close")})}generateChangesNotification(t){function e(t){return t.name}var i=[],n=t||this.collections.map(e);return this.collections.forEach(function(t){n.indexOf(e(t))!==-1&&(i=i.concat(t.getChanges()))}),i}serializeChanges(t){return JSON.stringify(this.generateChangesNotification(t))}clearChanges(){this.collections.forEach(function(t){t.flushChanges&&t.flushChanges()})}loadDatabase(t){var e=this;return null===this.persistenceAdapter?Promise.reject(new Error("persistenceAdapter not configured")):Promise.resolve(this.persistenceAdapter.loadDatabase(this.filename)).then(function(i){if("string"==typeof i)e.loadJSON(i,t||{}),e.emit("load",e);else{if("object"!=typeof i||null===i||i instanceof Error){if(i instanceof Error)throw i;throw new TypeError("The persistence adapter did not load a serialized DB string or object.")}e.loadJSONObject(i,t||{}),e.emit("load",e)}})}saveDatabase(){var t=this;if(null===this.persistenceAdapter)return Promise.reject(new Error("persistenceAdapter not configured"));var e;return e="reference"===this.persistenceAdapter.mode&&"function"==typeof this.persistenceAdapter.exportDatabase?this.persistenceAdapter.exportDatabase(this.filename,this.copy({removeNonSerializable:!0})):this.persistenceAdapter.saveDatabase(this.filename,t.serialize()),Promise.resolve(e).then(function(){t.autosaveClearFlags(),t.emit("save")})}save(){return this.saveDatabase()}deleteDatabase(){return null===this.persistenceAdapter?Promise.reject(new Error("persistenceAdapter not configured")):Promise.resolve(this.persistenceAdapter.deleteDatabase(this.filename))}autosaveDirty(){for(var t=0;t<this.collections.length;t++)if(this.collections[t].dirty)return!0;return!1}autosaveClearFlags(){for(var t=0;t<this.collections.length;t++)this.collections[t].dirty=!1}autosaveEnable(){if(!this.autosaveHandle){var t=this,e=!0;this.autosave=!0,this.autosaveHandle=function(){e=!1,t.autosaveHandle=void 0},function i(){setTimeout(function(){e&&t.saveDatabase().then(i,i)},t.autosaveInterval)}()}}autosaveDisable(){this.autosave=!1,this.autosaveHandle&&this.autosaveHandle()}}e.Loki=l}).call(e,function(){return this}())},function(t,e){"use strict";Object.defineProperty(e,"__esModule",{value:!0});class i{constructor(){this.events={},this.asyncListeners=!1}on(t,e){var i,n=this;return Array.isArray(t)?(t.forEach(function(t){n.on(t,e)}),e):(i=this.events[t],i||(i=this.events[t]=[]),i.push(e),e)}emit(t,e){var i=this;t&&this.events[t]&&this.events[t].forEach(function(t){i.asyncListeners?setTimeout(function(){t(e)},1):t(e)})}addListener(t,e){return this.on(t,e)}removeListener(t,e){var i=this;if(Array.isArray(t)&&t.forEach(function(t){i.removeListener(t,listen)}),this.events[t]){var n=this.events[t];n.splice(n.indexOf(e),1)}}}e.LokiEventEmitter=i},function(t,e){"use strict";Object.defineProperty(e,"__esModule",{value:!0});class i{constructor(){this.fs=void 0}loadDatabase(t){var e=this;return new Promise(function(i,n){e.fs.stat(t,function(r,s){!r&&s.isFile()?e.fs.readFile(t,{encoding:"utf8"},function(t,e){t?n(t):i(e)}):n()})})}saveDatabase(t,e){var i=this,n=t+"~";return new Promise(function(r,s){i.fs.writeFile(n,e,function(e){e?s(e):i.fs.rename(n,t,function(t){t?s(t):r()})})})}deleteDatabase(t){var e=this;return new Promise(function(i,n){e.fs.unlink(t,function(t){t?n(t):i()})})}}e.LokiFsAdapter=i},function(t,e){"use strict";function i(){try{return window&&void 0!==window.localStorage&&null!==window.localStorage}catch(t){return!1}}Object.defineProperty(e,"__esModule",{value:!0});class n{loadDatabase(t){return i()?Promise.resolve(localStorage.getItem(t)):Promise.reject(new Error("localStorage is not available"))}saveDatabase(t,e){return i()?(localStorage.setItem(t,e),Promise.resolve()):Promise.reject(new Error("localStorage is not available"))}deleteDatabase(t){return i()?(localStorage.removeItem(t),Promise.resolve()):Promise.reject(new Error("localStorage is not available"))}}e.LokiLocalStorageAdapter=n},function(t,e,i){"use strict";function n(t){return t.indexOf(".")!==-1}function r(t){return parseFloat(t,10)}function s(t,e){return t+e}function o(t,e){return t-e}function a(t){return t.reduce(s,0)/t.length}function l(t){var e=a(t),i=t.map(function(t){var i=t-e,n=i*i;return n}),n=a(i),r=Math.sqrt(n);return r}function u(t,e,i){if(i===!1)return t[e];for(var n=e.split("."),r=t;n.length>0;)r=r[n.shift()];return r}Object.defineProperty(e,"__esModule",{value:!0}),e.Collection=void 0;var h=i(2),c=i(6),f=i(7),d=i(8),p=i(12),y=i(9),v=i(11);class g extends h.LokiEventEmitter{constructor(t,e){function i(t){var e="function"==typeof Set?new Set:[];e.add||(e.add=function(t){return this.indexOf(t)===-1&&this.push(t),this}),t.forEach(function(t){e.add(t.object)}),e.forEach(function(t){if(!hasOwnProperty.call(t,"$loki"))return p.removeAutoUpdateObserver(t);try{p.update(t)}catch(t){}})}function n(t,e,i){p.changes.push({name:t,operation:e,obj:JSON.parse(JSON.stringify(i))})}function r(){p.changes=[]}function s(t){t&&(t.meta||(t.meta={}),t.meta.created=(new Date).getTime(),t.meta.revision=0)}function o(t){t&&(t.meta.updated=(new Date).getTime(),t.meta.revision+=1)}function a(t){n(p.name,"I",t)}function l(t){n(p.name,"U",t)}function u(t){s(t),a(t)}function h(t){o(t),l(t)}function d(){g=p.disableChangesApi?s:u,m=p.disableChangesApi?o:h}super(),this.name=t,this.data=[],this.idIndex=[],this.binaryIndices={},this.constraints={unique:{},exact:{}},this.uniqueNames=[],this.transforms={},this.objType=t,this.dirty=!0,this.cachedIndex=null,this.cachedBinaryIndex=null,this.cachedData=null;var p=this;e=e||{},e.hasOwnProperty("unique")&&(Array.isArray(e.unique)||(e.unique=[e.unique]),e.unique.forEach(function(t){p.uniqueNames.push(t),p.constraints.unique[t]=new c.UniqueIndex(t)})),e.hasOwnProperty("exact")&&e.exact.forEach(function(t){p.constraints.exact[t]=new f.ExactIndex(t)}),this.adaptiveBinaryIndices=!e.hasOwnProperty("adaptiveBinaryIndices")||e.adaptiveBinaryIndices,this.transactional=!!e.hasOwnProperty("transactional")&&e.transactional,this.cloneObjects=!!e.hasOwnProperty("clone")&&e.clone,this.cloneMethod=e.hasOwnProperty("cloneMethod")?e.cloneMethod:"parse-stringify",this.asyncListeners=!!e.hasOwnProperty("asyncListeners")&&e.asyncListeners,this.disableChangesApi=!e.hasOwnProperty("disableChangesApi")||e.disableChangesApi,this.autoupdate=!!e.hasOwnProperty("autoupdate")&&e.autoupdate,this.ttl={age:null,ttlInterval:null,daemon:null},this.setTTL(e.ttl||-1,e.ttlInterval),this.maxId=0,this.DynamicViews=[],this.events={insert:[],update:[],"pre-insert":[],"pre-update":[],close:[],flushbuffer:[],error:[],delete:[],warning:[]},this.changes=[],this.ensureId();var y=[];if(e&&e.indices)if("[object Array]"===Object.prototype.toString.call(e.indices))y=e.indices;else{if("string"!=typeof e.indices)throw new TypeError("Indices needs to be a string or an array of strings");y=[e.indices]}for(var v=0;v<y.length;v++)this.ensureIndex(y[v]);this.observerCallback=i,this.getChanges=function(){return p.changes},this.flushChanges=r;var g,m;d(),this.setChangesApi=function(t){p.disableChangesApi=!t,d()},this.on("insert",function(t){g(t)}),this.on("update",function(t){m(t)}),this.on("delete",function(t){p.disableChangesApi||n(p.name,"R",t)}),this.on("warning",function(t){p.console.warn(t)}),r(),this.console={log:function(){},warn:function(){},error:function(){}},this.stages={},this.commitLog=[]}addAutoUpdateObserver(t){this.autoupdate&&"function"==typeof Object.observe&&Object.observe(t,this.observerCallback,["add","update","delete","reconfigure","setPrototype"])}removeAutoUpdateObserver(t){this.autoupdate&&"function"==typeof Object.observe&&Object.unobserve(t,this.observerCallback)}addTransform(t,e){if(this.transforms.hasOwnProperty(t))throw new Error("a transform by that name already exists");this.transforms[t]=e}setTransform(t,e){this.transforms[t]=e}removeTransform(t){delete this.transforms[t]}byExample(t){var e,i,n;n=[];for(e in t)t.hasOwnProperty(e)&&n.push((i={},i[e]=t[e],i));return{$and:n}}findObject(t){return this.findOne(this.byExample(t))}findObjects(t){return this.find(this.byExample(t))}ttlDaemonFuncGen(){var t=this,e=this.ttl.age;return function(){var i=Date.now(),n=t.chain().where(function(t){var n=t.meta.updated||t.meta.created,r=i-n;return e<r});n.remove()}}setTTL(t,e){t<0?clearInterval(this.ttl.daemon):(this.ttl.age=t,this.ttl.ttlInterval=e,this.ttl.daemon=setInterval(this.ttlDaemonFuncGen(),e))}prepareFullDocIndex(){for(var t=this.data.length,e=new Array(t),i=0;i<t;i+=1)e[i]=i;return e}configureOptions(t){t=t||{},t.hasOwnProperty("adaptiveBinaryIndices")&&(this.adaptiveBinaryIndices=t.adaptiveBinaryIndices,this.adaptiveBinaryIndices&&this.ensureAllIndexes())}ensureIndex(t,e){if("undefined"==typeof e&&(e=!1),null===t||void 0===t)throw new Error("Attempting to set index without an associated property");if((!this.binaryIndices[t]||e||this.binaryIndices[t].dirty)&&(this.adaptiveBinaryIndices!==!0||!this.binaryIndices.hasOwnProperty(t)||e)){var i={name:t,dirty:!0,values:this.prepareFullDocIndex()};this.binaryIndices[t]=i;var n=function(t,e){return function(i,n){var r=e[i][t],s=e[n][t];if(r!==s){if((0,v.ltHelper)(r,s,!1))return-1;if((0,v.gtHelper)(r,s,!1))return 1}return 0}}(t,this.data);i.values.sort(n),i.dirty=!1,this.dirty=!0}}getSequencedIndexValues(t){var e,i=this.binaryIndices[t].values,n="";for(e=0;e<i.length;e++)n+=" ["+e+"] "+this.data[i[e]][t];return n}ensureUniqueIndex(t){var e=this.constraints.unique[t];return e||this.uniqueNames.indexOf(t)==-1&&this.uniqueNames.push(t),this.constraints.unique[t]=e=new c.UniqueIndex(t),this.data.forEach(function(t){e.set(t)}),e}ensureAllIndexes(t){var e,i=this.binaryIndices;for(e in i)hasOwnProperty.call(i,e)&&this.ensureIndex(e,t)}flagBinaryIndexesDirty(){var t,e=this.binaryIndices;for(t in e)hasOwnProperty.call(e,t)&&(e[t].dirty=!0)}flagBinaryIndexDirty(t){this.binaryIndices[t]&&(this.binaryIndices[t].dirty=!0)}count(t){return t?this.chain().find(t).filteredrows.length:this.data.length}ensureId(){var t=this.data.length,e=0;for(this.idIndex=[],e;e<t;e+=1)this.idIndex.push(this.data[e].$loki)}addDynamicView(t,e){var i=new p.DynamicView(this,t,e);return this.DynamicViews.push(i),i}removeDynamicView(t){for(var e=0;e<this.DynamicViews.length;e++)this.DynamicViews[e].name===t&&this.DynamicViews.splice(e,1)}getDynamicView(t){for(var e=0;e<this.DynamicViews.length;e++)if(this.DynamicViews[e].name===t)return this.DynamicViews[e];return null}findAndUpdate(t,e){"function"==typeof t?this.updateWhere(t,e):this.chain().find(t).update(e)}findAndRemove(t){this.chain().find(t).remove()}insert(t){if(!Array.isArray(t))return this.insertOne(t);var e,i=[];this.emit("pre-insert",t);for(var n=0,r=t.length;n<r;n++){if(e=this.insertOne(t[n],!0),!e)return;i.push(e)}return this.emit("insert",t),1===i.length?i[0]:i}insertOne(t,e){var i,n=null;if("object"!=typeof t?n=new TypeError("Document needs to be an object"):null===t&&(n=new TypeError("Object cannot be null")),null!==n)throw this.emit("error",n),n;var r=this.cloneObjects?(0,y.clone)(t,this.cloneMethod):t;if("undefined"==typeof r.meta&&(r.meta={revision:0,created:0}),e||this.emit("pre-insert",r),this.add(r))return i=this.cloneObjects?(0,y.clone)(r,this.cloneMethod):r,this.addAutoUpdateObserver(i),e||this.emit("insert",i),i}clear(t){var e=this;if(t=t||{},this.data=[],this.idIndex=[],this.cachedIndex=null,this.cachedBinaryIndex=null,this.cachedData=null,this.maxId=0,this.DynamicViews=[],this.dirty=!0,t.removeIndices===!0)this.binaryIndices={},this.constraints={unique:{},exact:{}},this.uniqueNames=[];else{var i=Object.keys(this.binaryIndices);i.forEach(function(t){e.binaryIndices[t].dirty=!1,e.binaryIndices[t].values=[]}),this.constraints={unique:{},exact:{}},this.uniqueNames.forEach(function(t){e.ensureUniqueIndex(t)})}}update(t){if(Array.isArray(t)){var e=0,i=t.length;for(e;e<i;e+=1)this.update(t[e])}else{if(!hasOwnProperty.call(t,"$loki"))throw new Error("Trying to update unsynced document. Please save the document first by using insert() or addMany()");try{this.startTransaction();var n,r,s,o=this.get(t.$loki,!0),a=this;if(!o)throw new Error("Trying to update a document not in collection.");n=o[0],s=o[1],r=this.cloneObjects?(0,y.clone)(t,this.cloneMethod):t,this.emit("pre-update",t),Object.keys(this.constraints.unique).forEach(function(t){a.constraints.unique[t].update(n,r)}),this.data[s]=r,r!==t&&this.addAutoUpdateObserver(t);for(var l=0;l<this.DynamicViews.length;l++)this.DynamicViews[l].evaluateDocument(s,!1);var u;if(this.adaptiveBinaryIndices){var h=this.binaryIndices;for(u in h)this.adaptiveBinaryIndexUpdate(s,u)}else this.flagBinaryIndexesDirty();return this.idIndex[s]=r.$loki,this.commit(),this.dirty=!0,this.emit("update",t,this.cloneObjects?(0,y.clone)(n,this.cloneMethod):null),t}catch(t){throw this.rollback(),this.console.error(t.message),this.emit("error",t),t}}}add(t){if("object"!=typeof t)throw new TypeError("Object being added needs to be an object");if("undefined"!=typeof t.$loki)throw new Error("Document is already in collection, please use update()");try{this.startTransaction(),this.maxId++,isNaN(this.maxId)&&(this.maxId=this.data[this.data.length-1].$loki+1),t.$loki=this.maxId,t.meta.version=0;var e,i=this.constraints.unique;for(e in i)hasOwnProperty.call(i,e)&&i[e].set(t);this.idIndex.push(t.$loki),this.data.push(t);for(var n=this.data.length-1,r=this.DynamicViews.length,s=0;s<r;s++)this.DynamicViews[s].evaluateDocument(n,!0);if(this.adaptiveBinaryIndices){var o=this.binaryIndices;for(e in o)this.adaptiveBinaryIndexInsert(n,e)}else this.flagBinaryIndexesDirty();return this.commit(),this.dirty=!0,this.cloneObjects?(0,y.clone)(t,this.cloneMethod):t}catch(t){throw this.rollback(),this.console.error(t.message),this.emit("error",t),t}}updateWhere(t,e){var i,n=this.where(t),r=0;try{for(r;r<n.length;r++)i=e(n[r]),this.update(i)}catch(t){this.rollback(),this.console.error(t.message)}}removeWhere(t){var e;"function"==typeof t?(e=this.data.filter(t),this.remove(e)):this.chain().find(t).remove()}removeDataOnly(){this.remove(this.data.slice())}remove(t){if("number"==typeof t&&(t=this.get(t)),"object"!=typeof t)throw new Error("Parameter is not an object");if(Array.isArray(t)){var e=0,i=t.length;for(e;e<i;e+=1)this.remove(t[e])}else{if(!hasOwnProperty.call(t,"$loki"))throw new Error("Object is not a document stored in the collection");try{this.startTransaction();var n=this.get(t.$loki,!0),r=n[1],s=this;Object.keys(this.constraints.unique).forEach(function(e){null!==t[e]&&"undefined"!=typeof t[e]&&s.constraints.unique[e].remove(t[e])});for(var o=0;o<this.DynamicViews.length;o++)this.DynamicViews[o].removeDocument(r);if(this.adaptiveBinaryIndices){var a,l=this.binaryIndices;for(a in l)this.adaptiveBinaryIndexRemove(r,a)}else this.flagBinaryIndexesDirty();return this.data.splice(r,1),this.removeAutoUpdateObserver(t),this.idIndex.splice(r,1),this.commit(),this.dirty=!0,this.emit("delete",n[0]),delete t.$loki,delete t.meta,t}catch(t){return this.rollback(),this.console.error(t.message),this.emit("error",t),null}}}get(t,e){var i=e||!1,n=this.idIndex,r=n.length-1,s=0,o=s+r>>1;if(t="number"==typeof t?t:parseInt(t,10),isNaN(t))throw new TypeError("Passed id is not an integer");for(;n[s]<n[r];)o=s+r>>1,n[o]<t?s=o+1:r=o;return r===s&&n[s]===t?i?[this.data[s],s]:this.data[s]:null}getBinaryIndexPosition(t,e){var i=this.data[t][e],n=this.binaryIndices[e].values,r=this.calculateRange("$eq",e,i);if(0===r[0]&&r[1]===-1)return null;for(var s=r[0],o=r[1],a=s;a<=o;a++)if(n[a]===t)return a;return null}adaptiveBinaryIndexInsert(t,e){var i=(this.binaryIndices[e].values,this.data[t][e]),n=this.calculateRangeStart(e,i);this.binaryIndices[e].values.splice(n,0,t)}adaptiveBinaryIndexUpdate(t,e){var i,n=this.binaryIndices[e].values,r=n.length;for(i=0;i<r&&n[i]!==t;i++);this.binaryIndices[e].values.splice(i,1),this.adaptiveBinaryIndexInsert(t,e)}adaptiveBinaryIndexRemove(t,e,i){var n,r,s=this.getBinaryIndexPosition(t,e),o=this.binaryIndices[e].values;if(null===s)return null;if(this.binaryIndices[e].values.splice(s,1),i!==!0)for(n=o.length,r=0;r<n;r++)o[r]>t&&o[r]--}calculateRangeStart(t,e){var i=this.data,n=this.binaryIndices[t].values,r=0,s=n.length-1,o=0;if(0===n.length)return 0;for(i[n[r]][t],i[n[s]][t];r<s;)o=r+s>>1,(0,v.ltHelper)(i[n[o]][t],e,!1)?r=o+1:s=o;var a=r;return(0,v.ltHelper)(i[n[a]][t],e,!1)?a+1:a}calculateRangeEnd(t,e){var i=this.data,n=this.binaryIndices[t].values,r=0,s=n.length-1,o=0;if(0===n.length)return 0;for(i[n[r]][t],i[n[s]][t];r<s;)o=r+s>>1,(0,v.ltHelper)(e,i[n[o]][t],!1)?s=o:r=o+1;var a=s;return(0,v.gtHelper)(i[n[a]][t],e,!1)?a-1:a}calculateRange(t,e,i){var n=this.data,r=this.binaryIndices[e].values,s=0,o=r.length-1,a=0;if(0===n.length)return[0,-1];var l=n[r[s]][e],u=n[r[o]][e];switch(t){case"$eq":case"$aeq":if((0,v.ltHelper)(i,l,!1)||(0,v.gtHelper)(i,u,!1))return[0,-1];break;case"$dteq":if((0,v.ltHelper)(i,l,!1)||(0,v.gtHelper)(i,u,!1))return[0,-1];break;case"$gt":if((0,v.gtHelper)(i,u,!0))return[0,-1];break;case"$gte":if((0,v.gtHelper)(i,u,!1))return[0,-1];break;case"$lt":if((0,v.ltHelper)(i,l,!0))return[0,-1];if((0,v.ltHelper)(u,i,!1))return[0,n.length-1];break;case"$lte":if((0,v.ltHelper)(i,l,!1))return[0,-1];if((0,v.ltHelper)(u,i,!0))return[0,n.length-1];break;case"$between":return[this.calculateRangeStart(e,i[0]),this.calculateRangeEnd(e,i[1])];case"$in":for(var h=[],c=[],f=0,d=i.length;f<d;f++)for(var p=this.calculateRange("$eq",e,i[f]),y=p[0];y<=p[1];y++)void 0===h[y]&&(h[y]=!0,c.push(y));return c}for(;s<o;)a=s+o>>1,(0,v.ltHelper)(n[r[a]][e],i,!1)?s=a+1:o=a;var g=s;for(o=r.length-1;s<o;)a=s+o>>1,(0,v.ltHelper)(i,n[r[a]][e],!1)?o=a:s=a+1;var m=o,w=n[r[g]][e],b=n[r[m]][e];switch(t){case"$eq":return w!==i?[0,-1]:(b!==i&&m--,[g,m]);case"$dteq":return w>i||w<i?[0,-1]:((b>i||b<i)&&m--,[g,m]);case"$gt":return(0,v.ltHelper)(b,i,!0)?[0,-1]:[m,n.length-1];case"$gte":return(0,v.ltHelper)(w,i,!1)?[0,-1]:[g,n.length-1];case"$lt":return 0===g&&(0,v.ltHelper)(w,i,!1)?[0,0]:[0,g-1];case"$lte":return b!==i&&m--,0===m&&(0,v.ltHelper)(b,i,!1)?[0,0]:[0,m];default:return[0,n.length-1]}}by(t,e){var i;if(void 0===e)return i=this,function(e){return i.by(t,e)};var n=this.constraints.unique[t].get(e);return this.cloneObjects?(0,y.clone)(n,this.cloneMethod):n}findOne(t){t=t||{};var e=new d.Resultset(this,{queryObj:t,firstOnly:!0});return Array.isArray(e)&&0===e.length?null:this.cloneObjects?(0,y.clone)(e,this.cloneMethod):e}chain(t,e){var i=new d.Resultset(this);return"undefined"==typeof t?i:i.transform(t,e)}find(t){"undefined"==typeof t&&(t="getAll");var e=new d.Resultset(this,{queryObj:t});return this.cloneObjects?(0,y.cloneObjectArray)(e,this.cloneMethod):e}findOneUnindexed(t,e){for(var i,n=this.data.length;n--;)if(this.data[n][t]===e)return i=this.data[n];return null}startTransaction(){if(this.transactional){this.cachedData=(0,y.clone)(this.data,this.cloneMethod),this.cachedIndex=this.idIndex,this.cachedBinaryIndex=this.binaryIndices;for(var t=0;t<this.DynamicViews.length;t++)this.DynamicViews[t].startTransaction()}}commit(){if(this.transactional){this.cachedData=null,this.cachedIndex=null,this.cachedBinaryIndex=null;for(var t=0;t<this.DynamicViews.length;t++)this.DynamicViews[t].commit()}}rollback(){if(this.transactional){null!==this.cachedData&&null!==this.cachedIndex&&(this.data=this.cachedData,this.idIndex=this.cachedIndex,this.binaryIndices=this.cachedBinaryIndex);for(var t=0;t<this.DynamicViews.length;t++)this.DynamicViews[t].rollback()}}where(t){var e=new d.Resultset(this,{queryFunc:t});return this.cloneObjects?(0,y.cloneObjectArray)(e,this.cloneMethod):e}mapReduce(t,e){try{return e(this.data.map(t))}catch(t){throw t}}eqJoin(t,e,i,n){return new d.Resultset(this).eqJoin(t,e,i,n)}getStage(t){return this.stages[t]||(this.stages[t]={}),this.stages[t]}stage(t,e){var i=JSON.parse(JSON.stringify(e));return this.getStage(t)[e.$loki]=i,i}commitStage(t,e){var i,n=this.getStage(t),r=(new Date).getTime();for(i in n)this.update(n[i]),this.commitLog.push({timestamp:r,message:e,data:JSON.parse(JSON.stringify(n[i]))});this.stages[t]={}}no_op(){}extract(t){var e=0,i=this.data.length,r=n(t),s=[];for(e;e<i;e+=1)s.push(u(this.data[e],t,r));return s}max(t){return Math.max.apply(null,this.extract(t))}min(t){return Math.min.apply(null,this.extract(t))}maxRecord(t){var e,i=0,r=this.data.length,s=n(t),o={index:0,value:void 0};for(i;i<r;i+=1)void 0!==e?e<u(this.data[i],t,s)&&(e=u(this.data[i],t,s),o.index=this.data[i].$loki):(e=u(this.data[i],t,s),o.index=this.data[i].$loki);return o.value=e,o}minRecord(t){var e,i=0,r=this.data.length,s=n(t),o={index:0,value:void 0};for(i;i<r;i+=1)void 0!==e?e>u(this.data[i],t,s)&&(e=u(this.data[i],t,s),o.index=this.data[i].$loki):(e=u(this.data[i],t,s),o.index=this.data[i].$loki);return o.value=e,o}extractNumerical(t){return this.extract(t).map(r).filter(Number).filter(function(t){return!isNaN(t)})}avg(t){return a(this.extractNumerical(t))}stdDev(t){return l(this.extractNumerical(t))}mode(t){var e={},i=this.extract(t);i.forEach(function(t){e[t]?e[t]+=1:e[t]=1});var n,r,s;for(r in e)n?n<e[r]&&(s=r):(s=r,n=e[r]);return s}median(t){var e=this.extractNumerical(t);e.sort(o);var i=Math.floor(e.length/2);return e.length%2?e[i]:(e[i-1]+e[i])/2}}e.Collection=g},function(t,e){"use strict";Object.defineProperty(e,"__esModule",{value:!0});class i{constructor(t){this.field=t,this.keyMap={},this.lokiMap={}}set(t){var e=t[this.field];if(null!==e&&"undefined"!=typeof e){if(this.keyMap[e])throw new Error("Duplicate key for property "+this.field+": "+e);this.keyMap[e]=t,this.lokiMap[t.$loki]=e}}get(t){return console.log(t),this.keyMap[t]}byId(t){return console.log("byId",key),this.keyMap[this.lokiMap[t]]}update(t,e){if(this.lokiMap[t.$loki]!==e[this.field]){var i=this.lokiMap[t.$loki];this.set(e),this.keyMap[i]=void 0}else this.keyMap[t[this.field]]=e}remove(t){var e=this.keyMap[t];if(null===e||"undefined"==typeof e)throw new Error("Key is not in unique index: "+this.field);this.keyMap[t]=void 0,this.lokiMap[e.$loki]=void 0}clear(){this.keyMap={},this.lokiMap={}}}e.UniqueIndex=i},function(t,e){"use strict";Object.defineProperty(e,"__esModule",{value:!0});class i{constructor(t){this.index={},this.field=t}set(t,e){this.index[t]?this.index[t].push(e):this.index[t]=[e],console.log("?")}remove(t,e){var i=this.index[t];for(var n in i)i[n]==e&&i.splice(n,1);i.length<1&&(this.index[t]=void 0)}get(t){return console.log("!"),this.index[t]}clear(t){this.index={};
}}e.ExactIndex=i},function(t,e,i){"use strict";function n(t){return"string"==typeof t||Array.isArray(t)?function(e){return t.indexOf(e)!==-1}:"object"==typeof t&&null!==t?function(e){return hasOwnProperty.call(t,e)}:null}function r(t,e){for(var i in e)if(hasOwnProperty.call(e,i))return f[i](t,e[i]);return!1}function s(t,e,i){return t===e?0:(0,c.ltHelper)(t,e,!1)?i?1:-1:(0,c.gtHelper)(t,e,!1)?i?-1:1:0}function o(t,e,i){for(var n,r,o=0,a=0,l=t.length;a<l;a++)if(n=t[a],r=n[0],o=s(e[r],i[r],n[1]),0!==o)return o;return 0}function a(t,e,i,n,r){var s=r||0,o=e[s];if(void 0===t||null===t||!hasOwnProperty.call(t,o))return!1;var l=!1,u=t[o];if(s+1>=e.length)l=i(u,n);else if(Array.isArray(u))for(var h=0,c=u.length;h<c&&(l=a(u[h],e,i,n,s+1),l!==!0);h+=1);else l=a(u,e,i,n,s+1);return l}Object.defineProperty(e,"__esModule",{value:!0}),e.Resultset=e.LokiOps=void 0;var l=(i(2),i(9)),u=i(5),h=i(10),c=i(11),f=e.LokiOps={$eq:function(t,e){return t===e},$aeq:function(t,e){return t==e},$ne:function(t,e){return e!==e?t===t:t!==e},$dteq:function(t,e){return!(0,c.ltHelper)(t,e,!1)&&!(0,c.gtHelper)(t,e,!1)},$gt:function(t,e){return(0,c.gtHelper)(t,e,!1)},$gte:function(t,e){return(0,c.gtHelper)(t,e,!0)},$lt:function(t,e){return(0,c.ltHelper)(t,e,!1)},$lte:function(t,e){return(0,c.ltHelper)(t,e,!0)},$between:function(t,e){return void 0!==t&&null!==t&&((0,c.gtHelper)(t,e[0],!0)&&(0,c.ltHelper)(t,e[1],!0))},$in:function(t,e){return e.indexOf(t)!==-1},$nin:function(t,e){return e.indexOf(t)===-1},$keyin:function(t,e){return t in e},$nkeyin:function(t,e){return!(t in e)},$definedin:function(t,e){return void 0!==e[t]},$undefinedin:function(t,e){return void 0===e[t]},$regex:function(t,e){return e.test(t)},$containsString:function(t,e){return"string"==typeof t&&t.indexOf(e)!==-1},$containsNone:function(t,e){return!f.$containsAny(t,e)},$containsAny:function(t,e){var i=n(t);return null!==i&&(Array.isArray(e)?e.some(i):i(e))},$contains:function(t,e){var i=n(t);return null!==i&&(Array.isArray(e)?e.every(i):i(e))},$type:function(t,e){var i=typeof t;return"object"===i&&(Array.isArray(t)?i="array":t instanceof Date&&(i="date")),"object"!=typeof e?i===e:r(i,e)},$size:function(t,e){return!!Array.isArray(t)&&("object"!=typeof e?t.length===e:r(t.length,e))},$len:function(t,e){return"string"==typeof t&&("object"!=typeof e?t.length===e:r(t.length,e))},$where:function(t,e){return e(t)===!0},$not:function(t,e){return!r(t,e)},$and:function(t,e){for(var i=0,n=e.length;i<n;i+=1)if(!r(t,e[i]))return!1;return!0},$or:function(t,e){for(var i=0,n=e.length;i<n;i+=1)if(r(t,e[i]))return!0;return!1}},d=["$eq","$aeq","$dteq","$gt","$gte","$lt","$lte","$in","$between"];class p{constructor(t,e){return e=e||{},e.queryObj=e.queryObj||null,e.queryFunc=e.queryFunc||null,e.firstOnly=e.firstOnly||!1,this.collection=t,this.searchIsChained=!e.queryObj&&!e.queryFunc,this.filteredrows=[],this.filterInitialized=!1,"undefined"!=typeof e.queryObj&&null!==e.queryObj?this.find(e.queryObj,e.firstOnly):"undefined"!=typeof e.queryFunc&&null!==e.queryFunc?this.where(e.queryFunc):this}reset(){return this.filteredrows.length>0&&(this.filteredrows=[]),this.filterInitialized=!1,this}toJSON(){var t=this.copy();return t.collection=null,t}limit(t){this.searchIsChained&&!this.filterInitialized&&0===this.filteredrows.length&&(this.filteredrows=this.collection.prepareFullDocIndex());var e=new p(this.collection);return e.filteredrows=this.filteredrows.slice(0,t),e.filterInitialized=!0,e}offset(t){this.searchIsChained&&!this.filterInitialized&&0===this.filteredrows.length&&(this.filteredrows=this.collection.prepareFullDocIndex());var e=new p(this.collection);return e.filteredrows=this.filteredrows.slice(t),e.filterInitialized=!0,e}copy(){var t=new p(this.collection);return this.filteredrows.length>0&&(t.filteredrows=this.filteredrows.slice()),t.filterInitialized=this.filterInitialized,t}branch(){return this.copy()}transform(t,e){var i,n,r=this;if("string"==typeof t&&this.collection.transforms.hasOwnProperty(t)&&(t=this.collection.transforms[t]),"object"!=typeof t||!Array.isArray(t))throw new Error("Invalid transform");for("undefined"!=typeof e&&(t=h.Utils.resolveTransformParams(t,e)),i=0;i<t.length;i++)switch(n=t[i],n.type){case"find":r.find(n.value);break;case"where":r.where(n.value);break;case"simplesort":r.simplesort(n.property,n.desc);break;case"compoundsort":r.compoundsort(n.value);break;case"sort":r.sort(n.value);break;case"limit":r=r.limit(n.value);break;case"offset":r=r.offset(n.value);break;case"map":r=r.map(n.value);break;case"eqJoin":r=r.eqJoin(n.joinData,n.leftJoinKey,n.rightJoinKey,n.mapFun);break;case"mapReduce":r=r.mapReduce(n.mapFunction,n.reduceFunction);break;case"update":r.update(n.value);break;case"remove":r.remove()}return r}instance(t){var e,i,n=this.data();t=t||{};var r=new u.Collection(t);for(e=0;e<n.length;e++)i=this.collection.cloneObjects?n[e]:(0,l.clone)(n[e],this.collection.cloneMethod),delete i.$loki,delete i.meta,r.insert(i);return r}sort(t){this.searchIsChained&&!this.filterInitialized&&0===this.filteredrows.length&&(this.filteredrows=this.collection.prepareFullDocIndex());var e=function(t,e){return function(i,n){return t(e[i],e[n])}}(t,this.collection.data);return this.filteredrows.sort(e),this}simplesort(t,e){if(this.searchIsChained&&!this.filterInitialized&&0===this.filteredrows.length){if(this.collection.binaryIndices.hasOwnProperty(t))return this.collection.ensureIndex(t),this.filteredrows=this.collection.binaryIndices[t].values.slice(0),this;this.filteredrows=this.collection.prepareFullDocIndex()}"undefined"==typeof e&&(e=!1);var i=function(t,e,i){return function(n,r){return s(i[n][t],i[r][t],e)}}(t,e,this.collection.data);return this.filteredrows.sort(i),this}compoundsort(t){if(0===t.length)throw new Error("Invalid call to compoundsort, need at least one property");var e;if(1===t.length)return e=t[0],Array.isArray(e)?this.simplesort(e[0],e[1]):this.simplesort(e,!1);for(var i=0,n=t.length;i<n;i+=1)e=t[i],Array.isArray(e)||(t[i]=[e,!1]);this.searchIsChained&&!this.filterInitialized&&0===this.filteredrows.length&&(this.filteredrows=this.collection.prepareFullDocIndex());var r=function(t,e){return function(i,n){return o(t,e[i],e[n])}}(t,this.collection.data);return this.filteredrows.sort(r),this}findOr(t){for(var e=null,i=0,n=0,r=[],s=[],o=0,a=this.count(),l=0,u=t.length;l<u;l++){if(e=this.branch().find(t[l]).filteredrows,n=e.length,n===a)return this;for(i=0;i<n;i++)o=e[i],void 0===s[o]&&(s[o]=!0,r.push(o))}return this.filteredrows=r,this.filterInitialized=!0,this}$or(){return this.findOr(...arguments)}findAnd(t){for(var e=0,i=t.length;e<i;e++){if(0===this.count())return this;this.find(t[e])}return this}$and(){return this.findAnd(...arguments)}find(t,e){if(0===this.collection.data.length)return this.searchIsChained?(this.filteredrows=[],this.filterInitialized=!0,this):[];var i,n,r,s,o,l,u=t||"getAll",h=!1,c=[],p=null;if(e=e||!1,"object"==typeof u)for(i in u)if(hasOwnProperty.call(u,i)){n=i,r=u[i];break}if(!n||"getAll"===u)return e?this.collection.data.length>0?this.collection.data[0]:null:this.searchIsChained?this:this.collection.data.slice();if("$and"===n||"$or"===n)return this.searchIsChained?(this[n](r),e&&this.filteredrows.length>1&&(this.filteredrows=this.filteredrows.slice(0,1)),this):(c=this.collection.chain()[n](r).data(),e?0===c.length?[]:c[0]:c);if(null===r||"object"!=typeof r||r instanceof Date)s="$eq",o=r;else{if("object"!=typeof r)throw new Error("Do not know what you want to do.");for(l in r)if(hasOwnProperty.call(r,l)){s=l,o=r[l];break}}"$regex"===s&&(Array.isArray(o)?o=new RegExp(o[0],o[1]):o instanceof RegExp||(o=new RegExp(o)));var y=n.indexOf(".")!==-1,v=!(y||this.searchIsChained&&this.filterInitialized);v&&this.collection.binaryIndices[n]&&d.indexOf(s)!==-1&&(this.collection.adaptiveBinaryIndices!==!0&&this.collection.ensureIndex(n),h=!0,p=this.collection.binaryIndices[n]);var g=f[s],m=this.collection.data,w=0,b=0;if(!this.searchIsChained){if(h){var I=this.collection.calculateRange(s,n,o);if(e)return I[1]!==-1?m[p.values[I[0]]]:[];if("$in"!==s)for(w=I[0];w<=I[1];w++)c.push(m[p.values[w]]);else for(w=0,b=I.length;w<b;w++)c.push(m[p.values[I[w]]])}else{if(w=m.length,e){if(y){for(n=n.split(".");w--;)if(a(m[w],n,g,o))return m[w]}else for(;w--;)if(g(m[w][n],o))return m[w];return[]}if(y)for(n=n.split(".");w--;)a(m[w],n,g,o)&&c.push(m[w]);else for(;w--;)g(m[w][n],o)&&c.push(m[w])}return c}var O,P=0;if(this.filterInitialized)if(O=this.filteredrows,b=O.length,y)for(n=n.split("."),w=0;w<b;w++)P=O[w],a(m[P],n,g,o)&&c.push(P);else for(w=0;w<b;w++)P=O[w],g(m[P][n],o)&&c.push(P);else{if(h){var x=this.collection.calculateRange(s,n,o);if("$in"!==s)for(w=x[0];w<=x[1];w++)c.push(p.values[w]);else for(w=0,b=x.length;w<b;w++)c.push(p.values[x[w]])}else if(b=m.length,y)for(n=n.split("."),w=0;w<b;w++)a(m[w],n,g,o)&&c.push(w);else for(w=0;w<b;w++)g(m[w][n],o)&&c.push(w);this.filterInitialized=!0}return this.filteredrows=c,this}where(t){var e,i=[];if("function"!=typeof t)throw new TypeError("Argument is not a stored view or a function");e=t;try{if(this.searchIsChained){if(this.filterInitialized){for(var n=this.filteredrows.length;n--;)e(this.collection.data[this.filteredrows[n]])===!0&&i.push(this.filteredrows[n]);return this.filteredrows=i,this}for(var r=this.collection.data.length;r--;)e(this.collection.data[r])===!0&&i.push(r);return this.filteredrows=i,this.filterInitialized=!0,this}for(var s=this.collection.data.length;s--;)e(this.collection.data[s])===!0&&i.push(this.collection.data[s]);return i}catch(t){throw t}}count(){return this.searchIsChained&&this.filterInitialized?this.filteredrows.length:this.collection.count()}data(t){var e,i,n,r=[],s=this.collection.data;if(t=t||{},this.searchIsChained&&!this.filterInitialized){if(0===this.filteredrows.length){if(this.collection.cloneObjects||t.forceClones){for(e=s.length,n=t.forceCloneMethod||this.collection.cloneMethod,i=0;i<e;i++)r.push((0,l.clone)(s[i],n));return r}return s.slice()}this.filterInitialized=!0}var o=this.filteredrows;if(e=o.length,this.collection.cloneObjects||t.forceClones)for(n=t.forceCloneMethod||this.collection.cloneMethod,i=0;i<e;i++)r.push((0,l.clone)(s[o[i]],n));else for(i=0;i<e;i++)r.push(s[o[i]]);return r}update(t){if("function"!=typeof t)throw new TypeError("Argument is not a function");this.searchIsChained&&!this.filterInitialized&&0===this.filteredrows.length&&(this.filteredrows=this.collection.prepareFullDocIndex());for(var e=this.filteredrows.length,i=this.collection.data,n=0;n<e;n++)t(i[this.filteredrows[n]]),this.collection.update(i[this.filteredrows[n]]);return this}remove(){return this.searchIsChained&&!this.filterInitialized&&0===this.filteredrows.length&&(this.filteredrows=this.collection.prepareFullDocIndex()),this.collection.remove(this.data()),this.filteredrows=[],this}mapReduce(t,e){try{return e(this.data().map(t))}catch(t){throw t}}eqJoin(t,e,i,n){var r,s,o,a=[],l=[],h=[],c="function"==typeof e,f="function"==typeof i,d={};if(a=this.data(),r=a.length,t instanceof p)l=t.data();else{if(!Array.isArray(t))throw new TypeError("joinData needs to be an array or result set");l=t}s=l.length;for(var y=0;y<s;y++)o=f?i(l[y]):l[y][i],d[o]=l[y];n||(n=function(t,e){return{left:t,right:e}});for(var v=0;v<r;v++)o=c?e(a[v]):a[v][e],h.push(n(a[v],d[o]||{}));return this.collection=new u.Collection("joinData"),this.collection.insert(h),this.filteredrows=[],this.filterInitialized=!1,this}map(t){var e=this.data().map(t);return this.collection=new u.Collection("mappedData"),this.collection.insert(e),this.filteredrows=[],this.filterInitialized=!1,this}}e.Resultset=p},function(t,e){"use strict";function i(t,e){if(null===t||void 0===t)return null;var i,n=e||"parse-stringify";switch(n){case"parse-stringify":i=JSON.parse(JSON.stringify(t));break;case"jquery-extend-deep":i=jQuery.extend(!0,{},t);break;case"shallow":i=Object.create(t.prototype||null),Object.keys(t).map(function(e){i[e]=t[e]})}return i}function n(t,e){var n,r=[];if("parse-stringify"==e)return i(t,e);for(n=t.length-1;n<=0;n--)r.push(i(t[n],e));return r}Object.defineProperty(e,"__esModule",{value:!0}),e.clone=i,e.cloneObjectArray=n},function(t,e){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var i=e.Utils={copyProperties:function(t,e){var i;for(i in t)e[i]=t[i]},resolveTransformObject:function(t,e,n){var r,s;if("number"!=typeof n&&(n=0),++n>=10)return t;for(r in t)"string"==typeof t[r]&&0===t[r].indexOf("[%lktxp]")?(s=t[r].substring(8),e.hasOwnProperty(s)&&(t[r]=e[s])):"object"==typeof t[r]&&(t[r]=i.resolveTransformObject(t[r],e,n));return t},resolveTransformParams:function(t,e){var n,r,s=[];if("undefined"==typeof e)return t;for(n=0;n<t.length;n++)r=JSON.parse(JSON.stringify(t[n])),s.push(i.resolveTransformObject(r,e));return s}}},function(t,e){"use strict";function i(t,e,i){var n,r;if(!t||!e||t===!0||e===!0){if(!(t!==!0&&t!==!1||e!==!0&&e!==!1))return i?t===e:!t&&e;if(void 0===e||null===e||t===!0||e===!1)return i;if(void 0===t||null===t||t===!1||e===!0)return!0}return t===e?i:t<e||!(t>e)&&(n=t.toString(),r=e.toString(),n==r?i:n<r)}function n(t,e,i){var n,r;if(!t||!e||t===!0||e===!0){if(!(t!==!0&&t!==!1||e!==!0&&e!==!1))return i?t===e:!!t&&!e;if(void 0===t||null===t||t===!1||e===!0)return i;if(void 0===e||null===e||t===!0||e===!1)return!0}return t===e?i:t>e||!(t<e)&&(n=t.toString(),r=e.toString(),n==r?i:n>r)}Object.defineProperty(e,"__esModule",{value:!0}),e.ltHelper=i,e.gtHelper=n},function(t,e,i){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.DynamicView=void 0;var n=i(2),r=i(8);class s extends n.LokiEventEmitter{constructor(t,e,i){super(),this.collection=t,this.name=e,this.rebuildPending=!1,this.options=i||{},this.options.hasOwnProperty("persistent")||(this.options.persistent=!1),this.options.hasOwnProperty("sortPriority")||(this.options.sortPriority="passive"),this.options.hasOwnProperty("minRebuildInterval")||(this.options.minRebuildInterval=1),this.resultset=new r.Resultset(t),this.resultdata=[],this.resultsdirty=!1,this.cachedresultset=null,this.filterPipeline=[],this.sortFunction=null,this.sortCriteria=null,this.sortDirty=!1,this.events={rebuild:[]}}rematerialize(t){var e,i,n;if(t=t||{},this.resultdata=[],this.resultsdirty=!0,this.resultset=new r.Resultset(this.collection),(this.sortFunction||this.sortCriteria)&&(this.sortDirty=!0),t.hasOwnProperty("removeWhereFilters"))for(e=this.filterPipeline.length,i=e;i--;)"where"===this.filterPipeline[i].type&&(i!==this.filterPipeline.length-1&&(this.filterPipeline[i]=this.filterPipeline[this.filterPipeline.length-1]),this.filterPipeline.length--);var s=this.filterPipeline;for(this.filterPipeline=[],e=s.length,n=0;n<e;n++)this.applyFind(s[n].val);return this.data(),this.emit("rebuild",this),this}branchResultset(t,e){var i=this.resultset.branch();return"undefined"==typeof t?i:i.transform(t,e)}toJSON(){var t=new s(this.collection,this.name,this.options);return t.resultset=this.resultset,t.resultdata=[],t.resultsdirty=!0,t.filterPipeline=this.filterPipeline,t.sortFunction=this.sortFunction,t.sortCriteria=this.sortCriteria,t.sortDirty=this.sortDirty,t.collection=null,t}removeFilters(t){t=t||{},this.rebuildPending=!1,this.resultset.reset(),this.resultdata=[],this.resultsdirty=!0,this.cachedresultset=null,this.filterPipeline=[],this.sortFunction=null,this.sortCriteria=null,this.sortDirty=!1,t.queueSortPhase===!0&&this.queueSortPhase()}applySort(t){return this.sortFunction=t,this.sortCriteria=null,this.queueSortPhase(),this}applySimpleSort(t,e){return this.sortCriteria=[[t,e||!1]],this.sortFunction=null,this.queueSortPhase(),this}applySortCriteria(t){return this.sortCriteria=t,this.sortFunction=null,this.queueSortPhase(),this}startTransaction(){return this.cachedresultset=this.resultset.copy(),this}commit(){return this.cachedresultset=null,this}rollback(){return this.resultset=this.cachedresultset,this.options.persistent&&(this.resultdata=this.resultset.data(),this.emit("rebuild",this)),this}_indexOfFilterWithId(t){if("string"==typeof t||"number"==typeof t)for(var e=0,i=this.filterPipeline.length;e<i;e+=1)if(t===this.filterPipeline[e].uid)return e;return-1}_addFilter(t){this.filterPipeline.push(t),this.resultset[t.type](t.val)}reapplyFilters(){this.resultset.reset(),this.cachedresultset=null,this.options.persistent&&(this.resultdata=[],this.resultsdirty=!0);var t=this.filterPipeline;this.filterPipeline=[];for(var e=0,i=t.length;e<i;e+=1)this._addFilter(t[e]);return this.sortFunction||this.sortCriteria?this.queueSortPhase():this.queueRebuildEvent(),this}applyFilter(t){var e=this._indexOfFilterWithId(t.uid);return e>=0?(this.filterPipeline[e]=t,this.reapplyFilters()):(this.cachedresultset=null,this.options.persistent&&(this.resultdata=[],this.resultsdirty=!0),this._addFilter(t),this.sortFunction||this.sortCriteria?this.queueSortPhase():this.queueRebuildEvent(),this)}applyFind(t,e){return this.applyFilter({type:"find",val:t,uid:e}),this}applyWhere(t,e){return this.applyFilter({type:"where",val:t,uid:e}),this}removeFilter(t){var e=this._indexOfFilterWithId(t);if(e<0)throw new Error("Dynamic view does not contain a filter with ID: "+t);return this.filterPipeline.splice(e,1),this.reapplyFilters(),this}count(){return this.resultsdirty&&(this.resultdata=this.resultset.data()),this.resultset.count()}data(){return(this.sortDirty||this.resultsdirty)&&this.performSortPhase({suppressRebuildEvent:!0}),this.options.persistent?this.resultdata:this.resultset.data()}queueRebuildEvent(){if(!this.rebuildPending){this.rebuildPending=!0;var t=this;setTimeout(function(){t.rebuildPending&&(t.rebuildPending=!1,t.emit("rebuild",t))},this.options.minRebuildInterval)}}queueSortPhase(){if(!this.sortDirty){this.sortDirty=!0;var t=this;"active"===this.options.sortPriority?setTimeout(function(){t.performSortPhase()},this.options.minRebuildInterval):this.queueRebuildEvent()}}performSortPhase(t){(this.sortDirty||this.resultsdirty)&&(t=t||{},this.sortDirty&&(this.sortFunction?this.resultset.sort(this.sortFunction):this.sortCriteria&&this.resultset.compoundsort(this.sortCriteria),this.sortDirty=!1),this.options.persistent&&(this.resultdata=this.resultset.data(),this.resultsdirty=!1),t.suppressRebuildEvent||this.emit("rebuild",this))}evaluateDocument(t,e){if(!this.resultset.filterInitialized)return this.options.persistent&&(this.resultdata=this.resultset.data()),void(this.sortFunction||this.sortCriteria?this.queueSortPhase():this.queueRebuildEvent());var i=this.resultset.filteredrows,n=e?-1:i.indexOf(+t),s=i.length,o=new r.Resultset(this.collection);o.filteredrows=[t],o.filterInitialized=!0;for(var a,l=0,u=this.filterPipeline.length;l<u;l++)a=this.filterPipeline[l],o[a.type](a.val);var h=0===o.filteredrows.length?-1:0;return n!==-1||h!==-1?n===-1&&h!==-1?(i.push(t),this.options.persistent&&this.resultdata.push(this.collection.data[t]),void(this.sortFunction||this.sortCriteria?this.queueSortPhase():this.queueRebuildEvent())):n!==-1&&h===-1?(n<s-1?(i.splice(n,1),this.options.persistent&&this.resultdata.splice(n,1)):(i.length=s-1,this.options.persistent&&(this.resultdata.length=s-1)),void(this.sortFunction||this.sortCriteria?this.queueSortPhase():this.queueRebuildEvent())):n!==-1&&h!==-1?(this.options.persistent&&(this.resultdata[n]=this.collection.data[t]),void(this.sortFunction||this.sortCriteria?this.queueSortPhase():this.queueRebuildEvent())):void 0:void 0}removeDocument(t){if(!this.resultset.filterInitialized)return this.options.persistent&&(this.resultdata=this.resultset.data()),void(this.sortFunction||this.sortCriteria?this.queueSortPhase():this.queueRebuildEvent());var e,i=this.resultset.filteredrows,n=i.indexOf(+t),r=i.length;for(n!==-1&&(n<r-1?(i[n]=i[r-1],i.length=r-1,this.options.persistent&&(this.resultdata[n]=this.resultdata[r-1],this.resultdata.length=r-1)):(i.length=r-1,this.options.persistent&&(this.resultdata.length=r-1)),this.sortFunction||this.sortCriteria?this.queueSortPhase():this.queueRebuildEvent()),r=i.length,e=0;e<r;e++)i[e]>t&&i[e]--}mapReduce(t,e){try{return e(this.data().map(t))}catch(t){throw t}}}e.DynamicView=s},function(t,e){"use strict";Object.defineProperty(e,"__esModule",{value:!0});class i{constructor(t){if(this.app="loki","undefined"!=typeof t&&(this.app=t),this.catalog=null,!this.checkAvailability())throw new Error("indexedDB does not seem to be supported for your environment")}checkAvailability(){return!("undefined"==typeof indexedDB||!indexedDB)}loadDatabase(t){var e=this.app,i=this;return null===this.catalog||null===this.catalog.db?new Promise(function(e){i.catalog=new n(function(n){i.catalog=n,e(i.loadDatabase(t))})}):new Promise(function(i){this.catalog.getAppKey(e,t,function(t){return 0===t.id?void i():void i(t.val)})})}loadKey(t){return this.loadDatabase(t)}saveDatabase(t,e){function i(t){t&&t.success===!0?r():s(new Error("Error saving database"))}var r,s,o=this.app,a=this,l=new Promise(function(t,e){r=t,s=e});return null===this.catalog||null===this.catalog.db?(this.catalog=new n(function(n){a.catalog=n,n.setAppKey(o,t,e,i)}),l):(this.catalog.setAppKey(o,t,e,i),l)}saveKey(t,e){return this.saveDatabase(t,e)}deleteDatabase(t){var e=this.app,i=this;return null===this.catalog||null===this.catalog.db?new Promise(function(e){i.catalog=new n(function(n){i.catalog=n,e(i.deleteDatabase(t))})}):new Promise(function(n){this.catalog.getAppKey(e,t,function(t){var e=t.id;0!==e&&i.catalog.deleteAppKey(e),n()})})}deleteKey(t){return this.deleteDatabase(t)}deleteDatabasePartitions(t){var e=this;this.getDatabaseList(function(i){i.forEach(function(i){i.startsWith(t)&&e.deleteDatabase(i)})})}getDatabaseList(t){var e=this.app,i=this;return null===this.catalog||null===this.catalog.db?void(this.catalog=new n(function(e){i.catalog=e,i.getDatabaseList(t)})):void this.catalog.getAppKeys(e,function(e){for(var i=[],n=0;n<e.length;n++)i.push(e[n].key);"function"==typeof t?t(i):i.forEach(function(t){console.log(t)})})}getKeyList(t){return this.getDatabaseList(t)}getCatalogSummary(t){var e=(this.app,this);return null===this.catalog||null===this.catalog.db?void(this.catalog=new n(function(i){e.catalog=i,e.getCatalogSummary(t)})):void this.catalog.getAllKeys(function(e){for(var i,n,r,s,o,a=[],l=0;l<e.length;l++)i=e[l],r=i.app||"",s=i.key||"",o=i.val||"",n=2*r.length+2*s.length+o.length+1,a.push({app:i.app,key:i.key,size:n});"function"==typeof t?t(a):a.forEach(function(t){console.log(t)})})}}e.LokiIndexedAdapter=i;class n{constructor(t){this.db=null,this.initializeLokiCatalog(t)}initializeLokiCatalog(t){var e=indexedDB.open("LokiCatalog",1),i=this;e.onupgradeneeded=function(t){var e=t.target.result;if(e.objectStoreNames.contains("LokiAKV")&&e.deleteObjectStore("LokiAKV"),!e.objectStoreNames.contains("LokiAKV")){var i=e.createObjectStore("LokiAKV",{keyPath:"id",autoIncrement:!0});i.createIndex("app","app",{unique:!1}),i.createIndex("key","key",{unique:!1}),i.createIndex("appkey","appkey",{unique:!0})}},e.onsuccess=function(e){i.db=e.target.result,"function"==typeof t&&t(i)},e.onerror=function(t){throw t}}getAppKey(t,e,i){var n=this.db.transaction(["LokiAKV"],"readonly"),r=n.objectStore("LokiAKV"),s=r.index("appkey"),o=t+","+e,a=s.get(o);a.onsuccess=function(t){return function(e){var i=e.target.result;null!==i&&"undefined"!=typeof i||(i={id:0,success:!1}),"function"==typeof t?t(i):console.log(i)}}(i),a.onerror=function(t){return function(e){if("function"!=typeof t)throw e;t({id:0,success:!1})}}(i)}getAppKeyById(t,e,i){var n=this.db.transaction(["LokiAKV"],"readonly"),r=n.objectStore("LokiAKV"),s=r.get(t);s.onsuccess=function(t,e){return function(i){"function"==typeof e?e(i.target.result,t):console.log(i.target.result)}}(i,e)}setAppKey(t,e,i,n){var r=this.db.transaction(["LokiAKV"],"readwrite"),s=r.objectStore("LokiAKV"),o=s.index("appkey"),a=t+","+e,l=o.get(a);l.onsuccess=function(r){var o=r.target.result;null===o||void 0===o?o={app:t,key:e,appkey:t+","+e,val:i}:o.val=i;var a=s.put(o);a.onerror=function(t){return function(e){"function"==typeof t?t({success:!1}):(console.error("LokiCatalog.setAppKey (set) onerror"),console.error(l.error))}}(n),a.onsuccess=function(t){return function(e){"function"==typeof t&&t({success:!0})}}(n)},l.onerror=function(t){return function(e){"function"==typeof t?t({success:!1}):(console.error("LokiCatalog.setAppKey (get) onerror"),console.error(l.error))}}(n)}deleteAppKey(t,e){var i=this.db.transaction(["LokiAKV"],"readwrite"),n=i.objectStore("LokiAKV"),r=n.delete(t);r.onsuccess=function(t){return function(e){"function"==typeof t&&t({success:!0})}}(e),r.onerror=function(t){return function(e){"function"==typeof t?t(!1):(console.error("LokiCatalog.deleteAppKey raised onerror"),console.error(r.error))}}(e)}getAppKeys(t,e){var i=this.db.transaction(["LokiAKV"],"readonly"),n=i.objectStore("LokiAKV"),r=n.index("app"),s=IDBKeyRange.only(t),o=r.openCursor(s),a=[];o.onsuccess=function(t,e){return function(i){var n=i.target.result;if(n){var r=n.value;t.push(r),n.continue()}else"function"==typeof e?e(t):console.log(t)}}(a,e),o.onerror=function(t){return function(e){"function"==typeof t?t(null):(console.error("LokiCatalog.getAppKeys raised onerror"),console.error(e))}}(e)}getAllKeys(t){var e=this.db.transaction(["LokiAKV"],"readonly"),i=e.objectStore("LokiAKV"),n=i.openCursor(),r=[];n.onsuccess=function(t,e){return function(i){var n=i.target.result;if(n){var r=n.value;t.push(r),n.continue()}else"function"==typeof e?e(t):console.log(t)}}(r,t),n.onerror=function(t){return function(e){"function"==typeof t&&t(null)}}(t)}}}])});
//# sourceMappingURL=lokijs.core.min.js.map